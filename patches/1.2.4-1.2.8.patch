--- a/.github/ISSUE_TEMPLATE.md
+++ b/.github/ISSUE_TEMPLATE.md
@@ -14,7 +14,8 @@
 
 #### Your setup
 
-* Magento version:
+* Magento version: 2.x.x
+* Amazon Pay Extension Version: 
 * Magento Edition: Community / Enterprise / Enterprise Cloud
 * JavaScript Console: Please add a screenshot of the Chrome JavaScript console to speed up the process
 * Shop URL : <!-- if you are willing to share -->

--- /dev/null
+++ b/CODE_OF_CONDUCT.md
@@ -0,0 +1,4 @@
+## Code of Conduct
+This project has adopted the [Amazon Open Source Code of Conduct](https://aws.github.io/code-of-conduct). 
+For more information see the [Code of Conduct FAQ](https://aws.github.io/code-of-conduct-faq) or contact 
+opensource-codeofconduct@amazon.com with any additional questions or comments.

--- /dev/null
+++ b/CONTRIBUTING.md
@@ -0,0 +1,61 @@
+# Contributing Guidelines
+
+Thank you for your interest in contributing to our project. Whether it's a bug report, new feature, correction, or additional 
+documentation, we greatly value feedback and contributions from our community.
+
+Please read through this document before submitting any issues or pull requests to ensure we have all the necessary 
+information to effectively respond to your bug report or contribution.
+
+
+## Reporting Bugs/Feature Requests
+
+We welcome you to use the GitHub issue tracker to report bugs or suggest features.
+
+When filing an issue, please check [existing open](https://github.com/amzn/amazon-payments-magento-2-plugin/issues), or [recently closed](https://github.com/amzn/amazon-payments-magento-2-plugin/issues?utf8=%E2%9C%93&q=is%3Aissue%20is%3Aclosed%20), issues to make sure somebody else hasn't already 
+reported the issue. Please try to include as much information as you can. Details like these are incredibly useful:
+
+* A reproducible test case or series of steps
+* The version of our code being used
+* Any modifications you've made relevant to the bug
+* Anything unusual about your environment or deployment
+
+
+## Contributing via Pull Requests
+Contributions via pull requests are much appreciated. Before sending us a pull request, please ensure that:
+
+1. You are working against the latest source on the *master* branch.
+2. You check existing open, and recently merged, pull requests to make sure someone else hasn't addressed the problem already.
+3. You open an issue to discuss any significant work - we would hate for your time to be wasted.
+
+To send us a pull request, please:
+
+1. Fork the repository.
+2. Modify the source; please focus on the specific change you are contributing. If you also reformat all the code, it will be hard for us to focus on your change.
+3. Ensure local tests pass.
+4. Commit to your fork using clear commit messages.
+5. Send us a pull request, answering any default questions in the pull request interface.
+6. Pay attention to any automated CI failures reported in the pull request, and stay involved in the conversation.
+
+GitHub provides additional document on [forking a repository](https://help.github.com/articles/fork-a-repo/) and 
+[creating a pull request](https://help.github.com/articles/creating-a-pull-request/).
+
+
+## Finding contributions to work on
+Looking at the existing issues is a great way to find something to contribute on. As our projects, by default, use the default GitHub issue labels ((enhancement/bug/duplicate/help wanted/invalid/question/wontfix), looking at any ['help wanted'](https://github.com/amzn/amazon-payments-magento-2-plugin/labels/help%20wanted) issues is a great place to start. 
+
+
+## Code of Conduct
+This project has adopted the [Amazon Open Source Code of Conduct](https://aws.github.io/code-of-conduct). 
+For more information see the [Code of Conduct FAQ](https://aws.github.io/code-of-conduct-faq) or contact 
+opensource-codeofconduct@amazon.com with any additional questions or comments.
+
+
+## Security issue notifications
+If you discover a potential security issue in this project we ask that you notify AWS/Amazon Security via our [vulnerability reporting page](http://aws.amazon.com/security/vulnerability-reporting/). Please do **not** create a public github issue.
+
+
+## Licensing
+
+See the [LICENSE](https://github.com/amzn/amazon-payments-magento-2-plugin/blob/master/LICENSE) file for our project's licensing. We will ask you to confirm the licensing of your contribution.
+
+We may ask you to sign a [Contributor License Agreement (CLA)](http://en.wikipedia.org/wiki/Contributor_License_Agreement) for larger changes.

--- a/README.md
+++ b/README.md
@@ -1,54 +1,23 @@
 # Amazon Pay and Login with Amazon for Magento 2
 
-[View the Complete User Guide](https://amzn.github.io/amazon-payments-magento-2-plugin)
+## About Amazon Pay for Magento 2
 
-## Learn More about Amazon Pay
-* [US] (https://pay.amazon.com/us/sp/magento)
-* [UK] (https://pay.amazon.com/uk/sp/magento)
-* [DE] (https://pay.amazon.com/de/sp/magento)
-* [FR] (https://pay.amazon.com/fr/sp/magento)
-* [IT] (https://pay.amazon.com/it/sp/magento)
-* [ES] (https://pay.amazon.com/es/sp/magento)
+Amazon Pay offers a familiar and convenient buying experience that can help your customers spend more time shopping and less time checking out.   Amazon Pay is used by large and small companies.  From years of shopping safely with Amazon, customers trust their personal information will remain secure and know many transactions are covered by the Amazon A-to-z Guarantee.  Businesses have the reassurance of our advanced fraud protection and payment protection policy.
 
+For more information about Amazon Pay and Magento 2, please visit our [Amazon Pay for Magento](https://pay.amazon.com/sp/magento) site or review our [Complete User Guide](https://amzn.github.io/amazon-payments-magento-2-plugin).
 
 ## Pre-Requisites
-* Magento 2.1+
-    * [Magento 2 System Requirements](http://devdocs.magento.com/magento-system-requirements.html)
+* Which version to download?
+
+| Magento Version  | Github Branch |
+| ------------- | ------------- |
+| 2.1.0 - 2.2.3  | [1.x](https://github.com/amzn/amazon-payments-magento-2-plugin/tree/1.x) |
+| 2.2.4 - 2.2.5  | [2.x](https://github.com/amzn/amazon-payments-magento-2-plugin/tree/2.x) |
+| 2.2.6 and above  | [master](https://github.com/amzn/amazon-payments-magento-2-plugin/tree/master) |
+
 * SSL is installed on your site and active on Checkout and Login pages
-* A verified Amazon Payments merchant account
+* A verified Amazon Pay merchant account - [sign up here](https://pay.amazon.com/signup)!
 
 ## Installation and Configuration
 
 Please follow the instructions in the [User Guide](https://amzn.github.io/amazon-payments-magento-2-plugin)
-
-## Release Notes
-### v1.1.1 stability
-#### Enhancements:
-        * Display the module version in the admin html
-        * Support for Modernizr 3.x
-        * Added extended support for japanese names
-        * Removed disturbing message for charge on order
-        * Configuration option to supply the store name added
-
-#### Bug Fixes:
-        * Order handling for free orders corrected
-        * Fixed incompatibility on CompleteOrder
-        * Displayed URLs did not take the store-view configured domain into account
-        * Removed unneeded CSS and layout
-        * jQuery storage API not always present
-
-### v1.1.0 Rebrand
-#### Enhancements:
-        * This release does not add any new features
-
-#### Bug Fixes:
-        * This release does not fix any bugs
-
-### v1.0.10 Small fixes
-#### Enhancements:
-   * #31 Scope parameter propagated to the Amazon Pay widgets
-   * #11 Integrate checkout agreement blocks in the checkout
-
-#### Bug Fixes:
-   * #27 Get the payment method from the order instead of the quote
-   * #33 Fix the checkout layout block to be in line with Magento 2.1

--- a/composer.json
+++ b/composer.json
@@ -2,10 +2,22 @@
   "name": "amzn/amazon-pay-and-login-magento-2-module",
   "description": "Official Magento2 Plugin to integrate with Amazon Pay and Login with Amazon",
   "type": "magento2-module",
-  "version": "1.2.4",
+  "version": "1.2.8",
   "license": [
     "Apache-2.0"
   ],
+  "require-dev": {
+    "guzzlehttp/guzzle": "^6.2.0",
+    "phpunit/phpunit": "4.1.0",
+    "behat/behat": "^3.1.0",
+    "behat/mink": "^1.7.1",
+    "behat/mink-extension": "^2.2",
+    "behat/mink-goutte-driver": "^1.2.1",
+    "behat/mink-selenium2-driver": "^1.3.1",
+    "sensiolabs/behat-page-object-extension": "^2.0.0",
+    "bex/behat-magento2-init": "dev-master",
+    "ciaranmcnulty/behat-stepthroughextension": "dev-master"
+  },
   "require": {
     "magento/framework": "^100.1.0|^101.0.0",
     "magento/module-sales": "^100.1.0|^101.0.0",
@@ -18,19 +30,7 @@
     "magento/module-quote": "^100.1.0|^101.0.0",
     "magento/module-customer": "^100.1.0|^101.0.0",
     "magento/module-store": "^100.1.0|^100.2.0",
-    "amzn/amazon-pay-sdk-php": "^3.1.0"
-  },
-  "require-dev": {
-    "guzzlehttp/guzzle": "^6.2.0",
-    "phpunit/phpunit": "4.1.0",
-    "behat/behat": "^3.1.0",
-    "behat/mink": "^1.7.1",
-    "behat/mink-extension": "^2.2",
-    "behat/mink-goutte-driver": "^1.2.1",
-    "behat/mink-selenium2-driver": "^1.3.1",
-    "sensiolabs/behat-page-object-extension": "^2.0.0",
-    "bex/behat-magento2-init": "dev-master",
-    "ciaranmcnulty/behat-stepthroughextension": "dev-master"
+    "amzn/amazon-pay-sdk-php": "^3.2.0"
   },
   "repositories": [
     {

--- a/docs/conf.py
+++ b/docs/conf.py
@@ -60,9 +60,9 @@ author = u'Amazon.com Inc or its affiliates'
 # built documents.
 #
 # The short X.Y version.
-version = u'1.1.1'
+version = u'1.2.8'
 # The full version, including alpha/beta/rc tags.
-release = u'1.1.1'
+release = u'1.2.8'
 
 # The language for content autogenerated by Sphinx. Refer to documentation
 # for a list of supported languages.

--- a/docs/configuration.rst
+++ b/docs/configuration.rst
@@ -25,7 +25,12 @@ The credentials can be found in Seller Central at :menuselection:`Integration --
 
 Payment Region
 ..............
-Select the region where you registered your seller account from the provided list. If you're unsure about this information, please consult the Amazon Pay merchant support.
+Select the region where you registered your seller account from the provided list. If you're unsure about this information, please consult the Amazon Pay merchant support. Supported regions are:
+
+* Euro (use for countries that use EUR as their currency, e.g. Germany, France, Italy, Spain, etc.)
+* United Kingdom
+* United States
+* Japan
 
 Sandbox
 .......

--- /dev/null
+++ b/docs/faq.rst
@@ -0,0 +1,29 @@
+Frequently Asked Questions (FAQ)
+================================
+
+I am using a custom theme, what do I have to do?
+------------------------------------------------
+
+The styles used in the extension are based on Magento's Luma theme. Responsive breakpoints and other variables, like `@screen__m`_, in the LESS files are defined by the Luma theme.
+If your custom theme is based on the Magento theme Luma or Blank, you should be fine. If it isn't, you should define all the variables and `Responsive Breakpoints` used.
+
+Magento provides detailed information about `Responsive Breakpoints` and responsive design in general. See `responsive.html in the magento2 repository`_ (vendor/magento/magento2-base/lib/web/css/docs/responsive.html in your Magento 2 installation) for more detailed explanations.
+
+`Magento DevDocs`_ gives additional information around this topic as well.
+
+Amazon Pay provides two LESS files in this extension. They need to be adapted to match your theme's responsive breakpoints.
+
+* https://github.com/amzn/amazon-payments-magento-2-plugin/blob/master/src/Login/view/frontend/web/css/source/_module.less
+* https://github.com/amzn/amazon-payments-magento-2-plugin/blob/master/src/Payment/view/frontend/web/css/source/_module.less
+
+
+.. _`@screen__m` : https://github.com/amzn/amazon-payments-magento-2-plugin/blob/1.2.4/src/Payment/view/frontend/web/css/source/_module.less#L71
+.. _`responsive.html in the magento2 repository` : https://github.com/magento/magento2/blob/2.2/lib/web/css/docs/responsive.html
+.. _`Magento DevDocs` : http://devdocs.magento.com/guides/v2.2/frontend-dev-guide/responsive-web-design/rwd_overview.html
+
+
+Amazon Pay Widgets are not surfaced
+-----------------------------------
+Please check if you are using a theme, which is not based on Magento's Luma or Blank theme first and follow the advice above.
+
+If this is not the case and you need help, please file an issue with us.

--- a/docs/index.rst
+++ b/docs/index.rst
@@ -16,4 +16,5 @@ Amazon Pay and Login with Amazon extension for Magento 2
    flow
    customisation
    testing
-   troubleshooting
\ No newline at end of file
+   troubleshooting
+   faq
\ No newline at end of file

--- a/docs/installation.rst
+++ b/docs/installation.rst
@@ -20,12 +20,12 @@ In case you are not able or willing to use the web installation, you can install
 
 * Sign in to your server via SSH
 * `cd` into you Magento installation directory
-* Install the extension via composer: `composer require amzn/amazon-payments-magento-2-plugin:^1.2.4`
+* Install the extension via composer: `composer require amzn/amazon-payments-magento-2-plugin:^1.2.8`
 * Enable the extension: `php bin/magento module:enable Amazon_Core Amazon_Login Amazon_Payment`
 * Upgrade the Magento installation: `php bin/magento setup:upgrade`
 * Follow any advice the upgrade routine provides
 
-.. note:: `composer require amzn/amazon-payments-magento-2-plugin:^1.2.4` will always instal the most current, non-breaking, Amazon Pay extension for you, when you run an update. To fix it to a specifix version, please remove the `^`
+.. note:: `composer require amzn/amazon-payments-magento-2-plugin:^1.2.8` will always install the most current, non-breaking, Amazon Pay extension for you, when you run an update. To fix it to a specifix version, please remove the `^`
 
 In production mode, you will also have to compile the code and the dependency injection (DI) configuration and deploy static content
 
@@ -38,8 +38,8 @@ In production mode, you will also have to compile the code and the dependency in
 
 Un-install Method
 --------------------------
-If there is a need ti disable the module, you can either disable Amazon Pay and Login with Amazon in the extension settings. This will temove all customer facing parts.
+If there is a need to disable the module, you can either disable Amazon Pay and Login with Amazon in the extension settings. This will remove all customer facing parts.
 
 To completely disable the module, please run `php bin/magento module:disable Amazon_Core Amazon_Login Amazon_Payment`
 
-To completely uninstall the module using composer, please run `composer remove amzn/amazon-payments-magento-2-plugin`
\ No newline at end of file
+To completely uninstall the module using composer, please run `composer remove amzn/amazon-payments-magento-2-plugin`

--- a/marketplace-composer.json
+++ b/marketplace-composer.json
@@ -2,14 +2,13 @@
   "name": "amzn/amazon-pay-and-login-magento-2-module",
   "description": "Official Magento2 Plugin to integrate with Amazon Pay and Login with Amazon",
   "type": "metapackage",
-  "version": "1.2.4",
+  "version": "1.2.8",
   "license": [
     "Apache-2.0"
   ],
   "require": {
-    "amzn/amazon-pay-sdk-php": "^3.1.0",
-    "amzn/amazon-pay-and-login-with-amazon-core-module": "1.2.4",
-    "amzn/login-with-amazon-module": "1.2.4",
-    "amzn/amazon-pay-module": "1.2.4"
+    "amzn/amazon-pay-and-login-with-amazon-core-module": "1.2.8",
+    "amzn/login-with-amazon-module": "1.2.8",
+    "amzn/amazon-pay-module": "1.2.8"
   }
 }

--- a/src/Core/Block/Config.php
+++ b/src/Core/Block/Config.php
@@ -96,6 +96,14 @@ class Config extends Template
         return ($this->coreHelper->isPwaEnabled());
     }
 
+    /**
+     * @return bool
+     */
+    public function isExtensionEnabled()
+    {
+	    return ($this->coreHelper->isPwaEnabled() || $this->coreHelper->isLwaEnabled());
+    }
+
     /**
      * @return bool
      */

--- a/src/Core/Helper/Data.php
+++ b/src/Core/Helper/Data.php
@@ -22,6 +22,9 @@ use Magento\Store\Model\ScopeInterface;
 use Magento\Store\Model\StoreManagerInterface;
 use Magento\Framework\Module\ModuleListInterface;
 
+/**
+ * @SuppressWarnings(PHPMD.ExcessivePublicCount)
+ */
 class Data extends AbstractHelper
 {
     const AMAZON_SECRET_KEY = 'secret_key';
@@ -31,8 +34,9 @@ class Data extends AbstractHelper
     const AMAZON_CLIENT_SECRET = 'client_secret';
     const AMAZON_REGION = 'region';
     const AMAZON_SANDBOX = 'sandbox';
+    const AMAZON_ACTIVE = 'payment/amazon_payment/active';
 
-    protected $amazonAccountUrl
+    private $amazonAccountUrl
         = [
             'us' => 'https://payments.amazon.com/overview',
             'uk' => 'https://payments.amazon.co.uk/overview',
@@ -43,7 +47,7 @@ class Data extends AbstractHelper
     /**
      * @var Array
      */
-    protected $amazonCredentialsFields
+    private $amazonCredentialsFields
         = [
             self::AMAZON_SECRET_KEY,
             self::AMAZON_ACCESS_KEY,
@@ -55,7 +59,7 @@ class Data extends AbstractHelper
     /**
      * @var Array
      */
-    protected $amazonCredentialsEncryptedFields
+    private $amazonCredentialsEncryptedFields
         = [
             self::AMAZON_SECRET_KEY,
             self::AMAZON_CLIENT_SECRET
@@ -64,12 +68,12 @@ class Data extends AbstractHelper
     /**
      * @var EncryptorInterface
      */
-    protected $encryptor;
+    private $encryptor;
 
     /**
      * @var StoreManagerInterface
      */
-    protected $storeManager;
+    private $storeManager;
 
     /**
      * @var \Amazon\Core\Helper\ClientIp
@@ -79,7 +83,7 @@ class Data extends AbstractHelper
     /**
      * @var ModuleListInterface
      */
-    protected $moduleList;
+    private $moduleList;
 
     /**
      * Data constructor.
@@ -218,7 +222,7 @@ class Data extends AbstractHelper
             'de' => 'https://static-eu.payments-amazon.com/OffAmazonPayments/de/lpa/js/Widgets.js?nomin',
             'uk' => 'https://static-eu.payments-amazon.com/OffAmazonPayments/uk/lpa/js/Widgets.js?nomin',
             'us' => 'https://static-na.payments-amazon.com/OffAmazonPayments/us/js/Widgets.js?nomin',
-            'jp' => 'https://origin-na.ssl-images-amazon.com/images/G/09/EP/offAmazonPayments/sandbox/prod/lpa/js/Widgets.js?nomin',
+            'jp' => 'https://static-fe.payments-amazon.com/OffAmazonPayments/jp/lpa/js/Widgets.js?nomin',
         ];
 
         if ($sandboxEnabled) {
@@ -226,7 +230,7 @@ class Data extends AbstractHelper
                 'de' => 'https://static-eu.payments-amazon.com/OffAmazonPayments/de/sandbox/lpa/js/Widgets.js?nomin',
                 'uk' => 'https://static-eu.payments-amazon.com/OffAmazonPayments/uk/sandbox/lpa/js/Widgets.js?nomin',
                 'us' => 'https://static-na.payments-amazon.com/OffAmazonPayments/us/sandbox/js/Widgets.js?nomin',
-                'jp' => 'https://origin-na.ssl-images-amazon.com/images/G/09/EP/offAmazonPayments/sandbox/prod/lpa/js/Widgets.js?nomin',
+                'jp' => 'https://static-fe.payments-amazon.com/OffAmazonPayments/jp/sandbox/lpa/js/Widgets.js?nomin',
             ];
         }
 
@@ -290,7 +294,7 @@ class Data extends AbstractHelper
         }
 
         return $this->scopeConfig->isSetFlag(
-            'payment/amazon_payment/pwa_enabled',
+            self::AMAZON_ACTIVE,
             $scope,
             $scopeCode
         );
@@ -312,6 +316,14 @@ class Data extends AbstractHelper
         );
     }
 
+    /*
+     * @return bool
+     */
+    public function isEnabled($scope = ScopeInterface::SCOPE_STORE, $scopeCode = null)
+    {
+        return $this->isLwaEnabled($scope, $scopeCode) || $this->isPwaEnabled($scope, $scopeCode);
+    }
+
     /*
      * @return string
      */
@@ -521,7 +533,8 @@ class Data extends AbstractHelper
 
         if (in_array($context, ['authorization', 'authorization_capture'])) {
             $simulationStrings['Authorization:Declined:InvalidPaymentMethod']
-                = '{"SandboxSimulation": {"State":"Declined", "ReasonCode":"InvalidPaymentMethod", "PaymentMethodUpdateTimeInMins":5}}';
+                = '{"SandboxSimulation": {"State":"Declined", "ReasonCode":"InvalidPaymentMethod", ' .
+                  '"PaymentMethodUpdateTimeInMins":5}}';
             $simulationStrings['Authorization:Declined:AmazonRejected']
                 = '{"SandboxSimulation": {"State":"Declined", "ReasonCode":"AmazonRejected"}}';
             $simulationStrings['Authorization:Declined:TransactionTimedOut']

--- a/src/Core/Model/Config/SimplePath.php
+++ b/src/Core/Model/Config/SimplePath.php
@@ -334,8 +334,8 @@ class SimplePath
      */
     public function autoEnable()
     {
-        if (!$this->getConfig('payment/amazon_payment/pwa_enabled')) {
-            $this->config->saveConfig('payment/amazon_payment/pwa_enabled', true, $this->_scope, $this->_scopeId);
+        if (!$this->getConfig('payment/amazon_payment/active')) {
+            $this->config->saveConfig('payment/amazon_payment/active', true, $this->_scope, $this->_scopeId);
             $this->messageManager->addSuccess(__("Login and Pay with Amazon is now enabled."));
         }
     }

--- a/src/Core/composer.json
+++ b/src/Core/composer.json
@@ -2,7 +2,7 @@
   "name": "amzn/amazon-pay-and-login-with-amazon-core-module",
   "description": "Shared functionality for Amazon Pay and Login with Amazon modules",
   "type": "magento2-module",
-  "version": "1.2.4",
+  "version": "1.2.8",
   "license": [
     "Apache-2.0"
   ],
@@ -12,7 +12,7 @@
     "magento/module-store": "^100.1.0|^100.2.0",
     "magento/module-developer": "^100.1.0|^100.2.0",
     "magento/module-quote": "^100.1.0|^101.0.0",
-    "amzn/amazon-pay-sdk-php": "^3.1.0"
+    "amzn/amazon-pay-sdk-php": "^3.2.0"
   },
   "autoload": {
     "files": ["registration.php"],

--- a/src/Core/etc/adminhtml/system.xml
+++ b/src/Core/etc/adminhtml/system.xml
@@ -66,10 +66,10 @@
                     </group>
                     <group id="options" translate="label" type="text" sortOrder="20" showInDefault="1" showInWebsite="1" showInStore="1">
                         <label>Options</label>
-                        <field id="pwa_enabled" translate="label" type="select" sortOrder="10" showInDefault="1" showInWebsite="1" showInStore="1">
+                        <field id="active" translate="label" type="select" sortOrder="10" showInDefault="1" showInWebsite="1" showInStore="1">
                             <label>Enable Amazon Pay</label>
                             <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
-                            <config_path>payment/amazon_payment/pwa_enabled</config_path>
+                            <config_path>payment/amazon_payment/active</config_path>
                         </field>
                         <field id="lwa_enabled" translate="label" type="select" sortOrder="20" showInDefault="1" showInWebsite="1" showInStore="1">
                             <label>Enable Login with Amazon</label>

--- a/src/Core/etc/config.xml
+++ b/src/Core/etc/config.xml
@@ -3,7 +3,7 @@
     <default>
         <payment>
             <amazon_payment>
-                <active>1</active>
+                <active>0</active>
                 <is_gateway>1</is_gateway>
                 <title>Amazon Pay</title>
                 <sort_order>1</sort_order>
@@ -15,7 +15,6 @@
                 <can_void>1</can_void>
                 <can_use_checkout>1</can_use_checkout>
                 <packstation_terms>Packstation,Pack-Station,Pack Station,PO Box,Post Office box,Locker</packstation_terms>
-                <pwa_enabled>0</pwa_enabled>
                 <lwa_enabled>0</lwa_enabled>
                 <authorization_mode>synchronous</authorization_mode>
                 <update_mechanism>polling</update_mechanism>

--- a/src/Core/etc/di.xml
+++ b/src/Core/etc/di.xml
@@ -2,7 +2,7 @@
 <config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
     <preference for="Amazon\Core\Client\ClientFactoryInterface" type="Amazon\Core\Client\ClientFactory" />
     <preference for="AmazonPay\ClientInterface" type="Amazon\Core\Client\Client" />
-    <type name="AmazonPay\ClientInterface">
+    <type name="Amazon\Core\Client\Client">
         <arguments>
             <argument name="config" xsi:type="array" />
         </arguments>
@@ -56,7 +56,7 @@
             </argument>
         </arguments>
     </virtualType>
-    <type name="Amazon\Core\Client\ClientFactoryInterface">
+    <type name="Amazon\Core\Client\ClientFactory">
         <arguments>
             <argument name="logger" xsi:type="object">amazonClientLogger</argument>
         </arguments>

--- a/src/Core/etc/module.xml
+++ b/src/Core/etc/module.xml
@@ -1,11 +1,13 @@
 <?xml version="1.0"?>
 <config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:Module/etc/module.xsd">
-    <module name="Amazon_Core" setup_version="1.2.4">
+    <module name="Amazon_Core" setup_version="1.2.8">
         <sequence>
-            <module name="Magento_Config" />
-            <module name="Magento_Store" />
-            <module name="Magento_Developer" />
-            <module name="Magento_Quote" />
+            <module name="Magento_Store"/>
+            <module name="Magento_Customer"/>
+            <module name="Magento_Payment"/>
+            <module name="Magento_Checkout"/>
+            <module name="Magento_Catalog"/>
+            <module name="Magento_Quote"/>
         </sequence>
     </module>
 </config>

--- a/src/Core/i18n/en_US.csv
+++ b/src/Core/i18n/en_US.csv
@@ -1,84 +1,117 @@
-"click here to display the categories","click here to display the categories"
-"No Simulation","No Simulation"
+"--","--"
+"A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station.","A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station."
+"A shop account for this email address already exists. Please enter your shop accounts password to log in without leaving the shop.","A store account for this email address already exists. Please enter your store account password to log in without leaving the store."
+"Access Key Id","Access Key Id"
+"Action is not available","Action is not available"
+"Advanced","Advanced"
+"Allowed IPs","Allowed IPs"
+"Allowed Javascript Origins","Allowed Javascript Origins"
+"Allowed Return URLs","Allowed Return URLs"
+"Amazon authorize invalid state : %1 with reason %2","Unexpected state for the Amazon Pay authoriziation. State: %1, Reason code: %2"
+"Amazon capture declined : %1","Amazon Pay declined the capture. Reason code: %1"
+"Amazon capture invalid state : %1 with reason %2","Unexpected state for the Amazon Pay capture. State: %1, Reason code: %2"
+"Amazon could not process your request.","Amazon Pay could not process your request. Please try again."
+"Amazon refund invalid state : %1 with reason %2","Unexpected state for the Amazon Pay refund. State: %1, Reason code: %2"
+"Amazon Pay","Amazon Pay"
+"Amazon Pay button in minicart","Amazon Pay button in minicart"
+"Amazon Pay button is visible on Product Page","Amazon Pay button is visible on Product Page"
+"Amazon Pay Logo","Amazon Pay Logo"
+"An unsupported currency is currently selected. Please review our configuration guide.","An unsupported currency is currently selected. Please review our configuration guide."
+"Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.","Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account."
+"Asynchronous","Asynchronous"
+"Authorization Mode","Authorization Mode"
 "Authorization soft decline","Authorization soft decline"
 "Authorization hard decline","Authorization hard decline"
 "Authorization timed out","Authorization timed out"
+"Back","Back"
+"Button Color","Button Color"
+"Button Display Language","Button Display Language"
+"Button Size","Button Size"
 "Capture declined","Capture declined"
 "Capture pending","Capture pending"
-"Refund declined","Refund declined"
-"Synchronous","Synchronous"
-"Asynchronous","Asynchronous"
-"Synchronous if Possible","Synchronous if Possible"
-"Gold","Gold"
-"Light Gray","Light Gray"
-"Dark Gray","Dark Gray"
-"Small","Small"
-"Medium","Medium"
-"Large","Large"
-"Extra Large","Extra Large"
-"Login with Amazon / Amazon Pay","Login with Amazon / Amazon Pay"
-"Login / Pay","Login / Pay"
-"Amazon Pay Logo","Amazon Pay Logo"
-"Charge on Shipment","Charge on Shipment"
+"Captured amount of %1 online","Captured amount of %1 online."
+"Capture declined for Order <a href=""%2"">#%1</a>","Capture declined for Order <a href=""%2"">#%1</a>"
+"Capture pending approval from the payment gateway","Capture pending approval from the payment gateway. Please check back later."
 "Charge on Order","Charge on Order"
-"Euro Region","Euro Region"
-"United Kingdom","United Kingdom"
-"United States","United States"
-"Japan","Japan"
-"Data Polling via Cron Job","Data Polling via Cron Job"
-"Instant Payment Notifications","Instant Payment Notifications"
-"Amazon Pay","Amazon Pay"
-General,General
-Credentials,Credentials
-"Merchant Id","Merchant Id"
-"Access Key Id","Access Key Id"
-"Secret Access Key","Secret Access Key"
+"Charge on Shipment","Charge on Shipment"
+"click here to display the categories","click here to display the categories"
 "Client Id","Client Id"
 "Client Secret","Client Secret"
+"Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
+                            If the field is empty, the buttons will be visible to all clients.","Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
+                            If the field is empty, the buttons will be visible to all clients."
+"Continue as Guest","Continue as Guest"
+"Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>.","Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>."
+"Could not find the ""multiline_count"" config of the ""street"" Customer address attribute.","Could not find the ""multiline_count"" config of the ""street"" Customer address attribute."
+"Credentials,Credentials"
 "Credentials JSON","Credentials JSON"
-"Payment Region","Payment Region"
-Sandbox,Sandbox
-"Allowed Javascript Origins","Allowed Javascript Origins"
-"Allowed Return URLs","Allowed Return URLs"
-Options,Options
+"Dark Gray","Dark Gray"
+"Data Polling via Cron Job","Data Polling via Cron Job"
+"Declined amount of %1 online","Online Capture of amount %1 was declined."
+"Developer Options","Developer Options"
 "Enable Amazon Pay","Enable Amazon Pay"
 "Enable Login with Amazon","Enable Login with Amazon"
-"Payment Action","Payment Action"
-"Authorization Mode","Authorization Mode"
-"Update Mechanism","Update Mechanism"
-"Amazon Pay button is visible on Product Page","Amazon Pay button is visible on Product Page"
-Advanced,Advanced
-Frontend,Frontend
-"Button Display Language","Button Display Language"
-"Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>.","Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>."
-"Button Color","Button Color"
-"Button Size","Button Size"
-"Sales Options","Sales Options"
-"New Order Status","New Order Status"
-"Sales Exclusions","Sales Exclusions"
-"Is Packing Stations Terms Validation Enabled","Is Packing Stations Terms Validation Enabled"
-"Packing Stations Terms","Packing Stations Terms"
-"A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station.","A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station."
+"Euro Region","Euro Region"
+"Error processing Amazon Login","Error processing Amazon Login"
 "Excluded Categories","Excluded Categories"
-"The ""Amazon Pay"" button will not be available for products of the selected categories.","The ""Amazon Pay"" button will not be available for products of the selected categories."
-"Developer Options","Developer Options"
-Logging,Logging
-"Allowed IPs","Allowed IPs"
-"Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
-                            If the field is empty, the buttons will be visible to all clients.","Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
-                            If the field is empty, the buttons will be visible to all clients."
-"Module version","Module version"
-"--","--"
-"Amazon Pay button in minicart","Amazon Pay button in minicart"
-"An unsupported currency is currently selected. Review our <a href=""%s"" target=""_blank"">configuration guide</a> for more information.","An unsupported currency is currently selected. Review our <a href=""%s"" target=""_blank"">configuration guide</a> for more information."
-"You will be registering for a %s account based on the base currency of your shop (%s). For more information, click <a href=""%s"" target=""_blank"">here</a>.","You will be registering for a %s account based on the base currency of your shop (%s). For more information, click <a href=""%s"" target=""_blank"">here</a>."
+"Extra Large","Extra Large"
+"Forgot Your Password?","Forgot Your Password?"
+"Frontend","Frontend"
+"General","General"
 "Get started with account registration","Get started with account registration"
+"Gold","Gold"
+"In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin.","In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin."
+"Instant Payment Notifications","Instant Payment Notifications"
+"Is Packing Stations Terms Validation Enabled","Is Packing Stations Terms Validation Enabled"
+"I've already setup Pay with Amazon, I want to edit my settings","I've already setup Amazon Pay, I want to edit my settings"
+"Japan","Japan"
+"Large","Large"
+"Light Gray","Light Gray"
+"Logging","Logging"
+"Login / Pay","Login / Pay"
+"Login with Amazon","Login with Amazon"
+"Login with Amazon / Amazon Pay","Login with Amazon / Amazon Pay"
+"Login with Amazon available in authentication popup","Login with Amazon available in authentication popup"
+"Medium","Medium"
+"Merchant Id","Merchant Id"
+"Module version","Module version"
 "My account is ready, I need to connect it to Magento","My account is ready, I need to connect it to Magento"
+"New Order Status","New Order Status"
+"No Simulation","No Simulation"
+"Ok","Ok"
+"Options","Options"
 "or","or"
-"I've already setup Pay with Amazon, I want to edit my settings","I've already setup Amazon Pay, I want to edit my settings"
-"Back","Back"
-"Updating your config with new keys, please wait...","Updating your config with new keys, please wait..."
-"In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin.","In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin."
+"Packing Stations Terms","Packing Stations Terms"
+"Password","Password"
 "Paste JSON credentials here","Paste JSON credentials here"
+"Payment Action","Payment Action"
+"Payment Region","Payment Region"
+"Please select a payment method.","Please select a payment method."
+"Refund declined","Refund declined"
+"* Required Fields","* Required Fields"
+"Return to standard checkout","Return to standard checkout"
+"Sales Exclusions","Sales Exclusions"
+"Sales Options","Sales Options"
+"Sandbox","Sandbox"
 "Save Credentials","Save Credentials"
+"Secret Access Key","Secret Access Key"
+"Securely login into our website using your existing Amazon details.","Securely login to our website using your existing Amazon details."
+"Simulate Payment Scenarios","Simulate Payment Scenarios"
+"Small","Small"
+"Synchronous","Synchronous"
+"Synchronous if Possible","Synchronous if Possible"
+"The ""Amazon Pay"" button will not be available for products of the selected categories.","The ""Amazon Pay"" button will not be available for products of the selected categories."
+"the country for your address is not allowed for this store","The country associated with your address is not allowed for this store."
+"The currency selected is not supported by Amazon Pay","The currency selected is not supported by Amazon Pay on this store."
+"the email address for your Amazon account is invalid","The email address for your Amazon account is invalid."
+"There has been a problem with the selected payment method on your Amazon account. Please choose another one.","There has been a problem with the selected payment method on your Amazon account. Please choose another one."
+"Unfortunately it is not possible to pay with Amazon Pay for this order. Please choose another payment method.","Unfortunately it is not possible to Pay with Amazon Pay for this order. Please choose another payment method."
+"United Kingdom","United Kingdom"
+"United States","United States"
+"Update Mechanism","Update Mechanism"
+"Updating your config with new keys, please wait...","Updating your config with new keys, please wait..."
 "Valid JSON credentials are required.","Valid JSON credentials are required."
+"Welcome back!","Welcome back!"
+"With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop.","With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop."
+"You will be registering for a %1 account based on the base currency of your shop (%2).","You will be registering for a %1 account based on the base currency of your shop (%2)."
+"Your session has expired, please reload the page and try again.","Your session has expired, please reload the page and try again."
\ No newline at end of file

--- a/src/Core/view/adminhtml/templates/system/config/simplepath_admin.phtml
+++ b/src/Core/view/adminhtml/templates/system/config/simplepath_admin.phtml
@@ -16,7 +16,7 @@
     </div>
 
     <span style="display:inline-block;padding:1em 0em;">
-        <button><span><?php echo __('Get started with account registration'); ?></span></button>
+        <button><span><?= $block->escapeHtml(__('Get started with account registration')); ?></span></button>
         &nbsp; &nbsp;
         <button><span><?php echo __('My account is ready, I need to connect it to Magento'); ?></span></button>
     </span>
@@ -40,14 +40,14 @@
 </div>
 
 <div id="amazon_simplepath_back" style="display:none;margin-bottom:1em;margin-top:-0.5em;">
-  <a href="#">&laquo; <?php echo __('Back'); ?></a>
+  <a href="#">&laquo; <?= $block->escapeHtml(__('Back')); ?></a>
 </div>
 
 <script>
 
 var AmazonSp = <?php echo $this->getAmazonSpJson(); ?>;
 
-require(["prototype"], function(){
+require(['uiRegistry', "prototype"], function(registry){
 
     // Country code for ID selectors
     var co = AmazonSp.co.toLowerCase();
@@ -104,7 +104,9 @@ require(["prototype"], function(){
         }
 
         var popupWidth = this.action.indexOf('payments-eu') == -1 ? 768 : 1050;
-        window.launchPopup('', popupWidth, popupHeight);
+        
+        var launchPopup = registry.get('launchPopup');
+        launchPopup('', popupWidth, popupHeight);
 
         // Show fields and import
         amazonFields.each(Element.show);
@@ -220,10 +222,9 @@ require(["jquery", "jquery/validate"], function($) {
 
 </script>
 
-
 <script>
 // Amazon Pop-up
-(function () {
+require(['uiRegistry'], function (registry) {
     'use strict';
 
     function launchPopup(url, requestedWidth, requestedHeight) {
@@ -268,6 +269,9 @@ require(["jquery", "jquery/validate"], function($) {
         }
     }
 
-    window.launchPopup = launchPopup;
-})();
-</script>
\ No newline at end of file
+    // window.launchPopup = launchPopup;
+    registry.set('launchPopup', launchPopup); 
+
+});
+</script>
+

--- a/src/Core/view/frontend/templates/amazon_payments_mark.phtml
+++ b/src/Core/view/frontend/templates/amazon_payments_mark.phtml
@@ -22,7 +22,7 @@
 <?php if($block->isBadgeEnabled()): ?>
     <div class="amazon-payments-mark-container">
         <div class="amazon-payments-mark _grad">
-            <span class="text"><?php /* @escapeNotVerified */ echo __('Amazon Pay'); ?></span>
+	    <span class="text"><?php /* @noEscape */ echo __('Amazon Pay'); ?></span>
         </div>
     </div>
-<?php endif; ?>
\ No newline at end of file
+<?php endif; ?>

--- a/src/Core/view/frontend/templates/config.phtml
+++ b/src/Core/view/frontend/templates/config.phtml
@@ -15,6 +15,12 @@
  */
 ?>
 
+<?php if ($block->isExtensionEnabled()) : ?>
 <script>
-    window.amazonPayment = <?php /* @escapeNotVerified */ echo \Zend_Json::encode($block->getConfig()); ?>;
-</script>
\ No newline at end of file
+
+require (['uiRegistry'], function(registry) {
+    registry.set('amazonPayment', <?= /* @noEscape */ \Zend_Json::encode($block->getConfig()); ?>);
+});
+
+</script>
+<?php endif ?>

--- /dev/null
+++ b/src/Login/Controller/Login.php
@@ -0,0 +1,190 @@
+<?php
+/**
+ * Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License").
+ * You may not use this file except in compliance with the License.
+ * A copy of the License is located at
+ *
+ *  http://aws.amazon.com/apache2.0
+ *
+ * or in the "license" file accompanying this file. This file is distributed
+ * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
+ * express or implied. See the License for the specific language governing
+ * permissions and limitations under the License.
+ */
+namespace Amazon\Login\Controller;
+
+use Amazon\Core\Client\ClientFactoryInterface;
+use Amazon\Core\Domain\AmazonCustomerFactory;
+use Amazon\Core\Helper\Data as AmazonCoreHelper;
+use Amazon\Login\Model\Validator\AccessTokenRequestValidator;
+use Amazon\Login\Model\Customer\Account\Redirect as AccountRedirect;
+use Amazon\Login\Helper\Session;
+use Magento\Customer\Model\Session as CustomerSession;
+use Magento\Customer\Model\Url;
+use Magento\Framework\App\Action\Action;
+use Magento\Framework\App\Action\Context;
+use Psr\Log\LoggerInterface;
+use Amazon\Login\Api\CustomerManagerInterface;
+use Amazon\Login\Api\Customer\CompositeMatcherInterface;
+
+/**
+ * Login with token controller
+ * @SuppressWarnings(PHPMD.CouplingBetweenObjects)
+ */
+abstract class Login extends Action
+{
+    /**
+     * @var AmazonCustomerFactory
+     */
+    protected $amazonCustomerFactory;
+
+    /**
+     * @var ClientFactoryInterface
+     */
+    protected $clientFactory;
+
+    /**
+     * @var AmazonCoreHelper
+     */
+    protected $amazonCoreHelper;
+
+    /**
+     * @var Url
+     */
+    protected $customerUrl;
+
+    /**
+     * @var AccessTokenRequestValidator
+     */
+    protected $accessTokenRequestValidator;
+
+    /**
+     * @var AccountRedirect
+     */
+    protected $accountRedirect;
+
+    /**
+     * @var CompositeMatcherInterface
+     */
+    protected $matcher;
+
+    /**
+     * @var CustomerManagerInterface
+     */
+    protected $customerLinkManagement;
+
+    /**
+     * @var CustomerSession
+     */
+    protected $customerSession;
+
+    /**
+     * @var Session
+     */
+    protected $session;
+
+    /**
+     * @var LoggerInterface
+     */
+    protected $logger;
+
+    /**
+     * @param AmazonCustomerFactory       $amazonCustomerFactory
+     * @param ClientFactoryInterface      $clientFactory
+     * @param LoggerInterface             $logger
+     * @param AmazonCoreHelper            $amazonCoreHelper
+     * @param Url                         $customerUrl
+     * @param AccessTokenRequestValidator $accessTokenRequestValidator
+     * @param AccountRedirect $accountRedirect
+     * @param CompositeMatcherInterface $matcher
+     * @param CustomerLinkManagementInterface $customerLinkManagement
+     * @param CustomerSession $customerSession
+     * @param Session $session
+     * @param LoggerInterface $logger
+     * @SuppressWarnings(PHPMD.ExcessiveParameterList)
+     */
+    public function __construct(
+        Context $context,
+        AmazonCustomerFactory $amazonCustomerFactory,
+        ClientFactoryInterface $clientFactory,
+        AmazonCoreHelper $amazonCoreHelper,
+        Url $customerUrl,
+        AccessTokenRequestValidator $accessTokenRequestValidator,
+        AccountRedirect $accountRedirect,
+        CompositeMatcherInterface $matcher,
+        CustomerManagerInterface $customerLinkManagement,
+        CustomerSession $customerSession,
+        Session $session,
+        LoggerInterface $logger
+    ) {
+        $this->amazonCustomerFactory       = $amazonCustomerFactory;
+        $this->clientFactory               = $clientFactory;
+        $this->amazonCoreHelper            = $amazonCoreHelper;
+        $this->customerUrl                 = $customerUrl;
+        $this->accessTokenRequestValidator = $accessTokenRequestValidator;
+        $this->accountRedirect             = $accountRedirect;
+        $this->matcher                     = $matcher;
+        $this->customerLinkManagement      = $customerLinkManagement;
+        $this->customerSession             = $customerSession;
+        $this->session                     = $session;
+        $this->logger                      = $logger;
+        parent::__construct($context);
+    }
+
+    /**
+     * Load userinfo from access token
+     *
+     * @return AmazonCustomer|bool
+     */
+    protected function getAmazonCustomer()
+    {
+        try {
+            $userInfo = $this->clientFactory
+                             ->create()
+                             ->getUserInfo($this->getRequest()->getParam('access_token'));
+
+            if (is_array($userInfo) && isset($userInfo['user_id'])) {
+                $data = [
+                    'id'      => $userInfo['user_id'],
+                    'email'   => $userInfo['email'],
+                    'name'    => $userInfo['name'],
+                    'country' => $this->amazonCoreHelper->getRegion(),
+                ];
+                $amazonCustomer = $this->amazonCustomerFactory->create($data);
+
+                return $amazonCustomer;
+            }
+        } catch (\Exception $e) {
+            $this->logger->error($e);
+            $this->messageManager->addErrorMessage(__('Error processing Amazon Login'));
+        }
+
+        return false;
+    }
+
+    /**
+     * @return bool
+     */
+    protected function isValidToken()
+    {
+        return $this->accessTokenRequestValidator->isValid($this->getRequest());
+    }
+
+    /**
+     * @return string
+     */
+    protected function getRedirectLogin()
+    {
+        return $this->_redirect($this->customerUrl->getLoginUrl());
+    }
+
+    /**
+     * @return string
+     */
+    protected function getRedirectAccount()
+    {
+        return $this->accountRedirect->getRedirect();
+    }
+}

--- a/src/Login/Controller/Login/Authorize.php
+++ b/src/Login/Controller/Login/Authorize.php
@@ -15,137 +15,31 @@
  */
 namespace Amazon\Login\Controller\Login;
 
-use Amazon\Core\Client\ClientFactoryInterface;
 use Amazon\Core\Domain\AmazonCustomer;
 use Amazon\Core\Domain\AmazonCustomerFactory;
-use Amazon\Core\Helper\Data as AmazonCoreHelper;
-use Amazon\Login\Api\Customer\CompositeMatcherInterface;
-use Amazon\Login\Api\CustomerManagerInterface;
 use Amazon\Login\Domain\ValidationCredentials;
-use Amazon\Login\Helper\Session;
-use Amazon\Login\Model\Validator\AccessTokenRequestValidator;
-use Amazon\Login\Model\Customer\Account\Redirect as AccountRedirect;
-use Magento\Customer\Model\Url;
-use Magento\Framework\App\Action\Action;
-use Magento\Framework\App\Action\Context;
-use Magento\Framework\Exception\NotFoundException;
 use Magento\Framework\Exception\ValidatorException;
-use Psr\Log\LoggerInterface;
+use Magento\Framework\Exception\NotFoundException;
 use Zend_Validate;
 
-class Authorize extends Action
+class Authorize extends \Amazon\Login\Controller\Login
 {
     /**
-     * @var ClientFactoryInterface
-     */
-    protected $clientFactory;
-
-    /**
-     * @var CompositeMatcherInterface
+     * {@inheritdoc}
      */
-    protected $matcher;
-
-    /**
-     * @var CustomerManagerInterface
-     */
-    protected $customerManager;
-
-    /**
-     * @var Session
-     */
-    protected $session;
-
-    /**
-     * @var AccountRedirect
-     */
-    protected $accountRedirect;
-
-    /**
-     * @var AmazonCustomerFactory
-     */
-    protected $amazonCustomerFactory;
-
-    /**
-     * @var LoggerInterface
-     */
-    protected $logger;
-
-    /**
-     * @var AmazonCoreHelper
-     */
-    protected $amazonCoreHelper;
-
-    /**
-     * @var Url
-     */
-    protected $customerUrl;
-
-    /**
-     * @var AccessTokenRequestValidator
-     */
-    protected $accessTokenRequestValidator;
-
-    /**
-     * @param Context                     $context
-     * @param ClientFactoryInterface      $clientFactory
-     * @param CompositeMatcherInterface   $matcher
-     * @param CustomerManagerInterface    $customerManager
-     * @param Session                     $session
-     * @param AccountRedirect             $accountRedirect
-     * @param AmazonCustomerFactory       $amazonCustomerFactory
-     * @param LoggerInterface             $logger
-     * @param AmazonCoreHelper            $amazonCoreHelper
-     * @param Url                         $customerUrl
-     * @param AccessTokenRequestValidator $accessTokenRequestValidator
-     */
-    public function __construct(
-        Context $context,
-        ClientFactoryInterface $clientFactory,
-        CompositeMatcherInterface $matcher,
-        CustomerManagerInterface $customerManager,
-        Session $session,
-        AccountRedirect $accountRedirect,
-        AmazonCustomerFactory $amazonCustomerFactory,
-        LoggerInterface $logger,
-        AmazonCoreHelper $amazonCoreHelper,
-        Url $customerUrl,
-        AccessTokenRequestValidator $accessTokenRequestValidator
-    ) {
-        parent::__construct($context);
-
-        $this->clientFactory               = $clientFactory;
-        $this->matcher                     = $matcher;
-        $this->customerManager             = $customerManager;
-        $this->session                     = $session;
-        $this->accountRedirect             = $accountRedirect;
-        $this->amazonCustomerFactory       = $amazonCustomerFactory;
-        $this->logger                      = $logger;
-        $this->amazonCoreHelper            = $amazonCoreHelper;
-        $this->customerUrl                 = $customerUrl;
-        $this->accessTokenRequestValidator = $accessTokenRequestValidator;
-    }
-
     public function execute()
     {
-        if (! $this->amazonCoreHelper->isLwaEnabled()) {
+        if (!$this->amazonCoreHelper->isLwaEnabled()) {
             throw new NotFoundException(__('Action is not available'));
         }
 
-        if (! $this->accessTokenRequestValidator->isValid($this->getRequest())) {
-            return $this->_redirect($this->customerUrl->getLoginUrl());
+        if (!$this->isValidToken()) {
+            return $this->getRedirectLogin();
         }
 
         try {
-            $userInfo = $this->clientFactory->create()->getUserInfo($this->getRequest()->getParam('access_token'));
-
-            if (is_array($userInfo) && isset($userInfo['user_id'])) {
-                $amazonCustomer = $this->amazonCustomerFactory->create([
-                    'id'    => $userInfo['user_id'],
-                    'email' => $userInfo['email'],
-                    'name'  => $userInfo['name'],
-                    'country' => $this->amazonCoreHelper->getRegion()
-                ]);
-
+            $amazonCustomer = $this->getAmazonCustomer();
+            if ($amazonCustomer) {
                 $processed = $this->processAmazonCustomer($amazonCustomer);
 
                 if ($processed instanceof ValidationCredentials) {
@@ -167,7 +61,7 @@ class Authorize extends Action
             $this->_eventManager->dispatch('amazon_login_authorize_error', ['exception' => $e]);
         }
 
-        return $this->accountRedirect->getRedirect();
+        return $this->getRedirectAccount();
     }
 
     protected function processAmazonCustomer(AmazonCustomer $amazonCustomer)
@@ -183,7 +77,7 @@ class Authorize extends Action
                 return new ValidationCredentials($customerData->getId(), $amazonCustomer->getId());
             }
 
-            $this->customerManager->updateLink($customerData->getId(), $amazonCustomer->getId());
+            $this->customerLinkManagement->updateLink($customerData->getId(), $amazonCustomer->getId());
         }
 
         return $customerData;
@@ -195,8 +89,8 @@ class Authorize extends Action
             throw new ValidatorException(__('the email address for your Amazon account is invalid'));
         }
 
-        $customerData = $this->customerManager->create($amazonCustomer);
-        $this->customerManager->updateLink($customerData->getId(), $amazonCustomer->getId());
+        $customerData = $this->customerLinkManagement->create($amazonCustomer);
+        $this->customerLinkManagement->updateLink($customerData->getId(), $amazonCustomer->getId());
 
         return $customerData;
     }

--- a/src/Login/Controller/Login/Guest.php
+++ b/src/Login/Controller/Login/Guest.php
@@ -13,94 +13,79 @@
  * express or implied. See the License for the specific language governing
  * permissions and limitations under the License.
  */
+
 namespace Amazon\Login\Controller\Login;
 
 use Amazon\Core\Client\ClientFactoryInterface;
-use Amazon\Core\Domain\AmazonCustomer;
-use Amazon\Core\Domain\AmazonCustomerFactory;
 use Amazon\Core\Helper\Data as AmazonCoreHelper;
 use Amazon\Login\Model\Validator\AccessTokenRequestValidator;
-use Amazon\Login\Model\Customer\Account\Redirect as AccountRedirect;
-use Magento\Customer\Model\Session;
+use Magento\Checkout\Model\Session;
 use Magento\Customer\Model\Url;
 use Magento\Framework\App\Action\Action;
 use Magento\Framework\App\Action\Context;
-use Magento\Framework\Exception\NotFoundException;
 use Psr\Log\LoggerInterface;
 
 class Guest extends Action
 {
     /**
-     * @var AmazonCustomerFactory
+     * @var AmazonCoreHelper
      */
-    protected $amazonCustomerFactory;
+    private $amazonCoreHelper;
 
     /**
-     * @var ClientFactoryInterface
+     * @var Url
      */
-    protected $clientFactory;
+    private $customerUrl;
 
     /**
-     * @var LoggerInterface
+     * @var AccessTokenRequestValidator
      */
-    protected $logger;
+    private $accessTokenRequestValidator;
 
     /**
      * @var Session
      */
-    protected $customerSession;
+    private $session;
 
     /**
-     * @var AmazonCoreHelper
-     */
-    protected $amazonCoreHelper;
-
-    /**
-     * @var Url
+     * @var ClientFactoryInterface
      */
-    protected $customerUrl;
+    private $clientFactory;
 
     /**
-     * @var AccessTokenRequestValidator
+     * @var LoggerInterface
      */
-    protected $accessTokenRequestValidator;
+    private $logger;
 
-    /**
-     * @var AccountRedirect
-     */
-    protected $accountRedirect;
+    private $quoteRepository;
 
     /**
-     * @param Context                     $context
-     * @param AmazonCustomerFactory       $amazonCustomerFactory
-     * @param ClientFactoryInterface      $clientFactory
-     * @param LoggerInterface             $logger
-     * @param Session                     $customerSession
-     * @param AmazonCoreHelper            $amazonCoreHelper
-     * @param Url                         $customerUrl
+     * Guest constructor.
+     * @param Context $context
+     * @param AmazonCoreHelper $amazonCoreHelper
+     * @param Url $customerUrl
      * @param AccessTokenRequestValidator $accessTokenRequestValidator
-     * @param AccountRedirect             $accountRedirect
+     * @param Session $session
+     * @param ClientFactoryInterface $clientFactory
+     * @param LoggerInterface $logger
      */
     public function __construct(
         Context $context,
-        AmazonCustomerFactory $amazonCustomerFactory,
-        ClientFactoryInterface $clientFactory,
-        LoggerInterface $logger,
-        Session $customerSession,
         AmazonCoreHelper $amazonCoreHelper,
         Url $customerUrl,
         AccessTokenRequestValidator $accessTokenRequestValidator,
-        AccountRedirect $accountRedirect
-    ) {
-        parent::__construct($context);
-        $this->amazonCustomerFactory = $amazonCustomerFactory;
-        $this->clientFactory = $clientFactory;
-        $this->logger = $logger;
-        $this->customerSession = $customerSession;
+        Session $session,
+        ClientFactoryInterface $clientFactory,
+        LoggerInterface $logger
+    )
+    {
         $this->amazonCoreHelper = $amazonCoreHelper;
         $this->customerUrl = $customerUrl;
         $this->accessTokenRequestValidator = $accessTokenRequestValidator;
-        $this->accountRedirect = $accountRedirect;
+        $this->session = $session;
+        $this->clientFactory = $clientFactory;
+        $this->logger = $logger;
+        parent::__construct($context);
     }
 
     /**
@@ -108,43 +93,70 @@ class Guest extends Action
      */
     public function execute()
     {
-        if ($this->amazonCoreHelper->isLwaEnabled()) {
-            throw new NotFoundException(__('Action is not available'));
+        if (!$this->isValidToken()) {
+            return $this->getRedirectLogin();
         }
 
-        if (! $this->accessTokenRequestValidator->isValid($this->getRequest())) {
-            return $this->_redirect($this->customerUrl->getLoginUrl());
+        $customerData = $this->getAmazonCustomer();
+        if ($customerData && isset($customerData['email'])) {
+            $quote = $this->session->getQuote();
+
+            if ($quote) {
+                $quote->setCustomerEmail($customerData['email']);
+                $quote->save();
+            }
         }
 
+        return $this->_redirect('checkout');
+    }
+
+    /**
+     * @return string
+     */
+    private function getRedirectLogin()
+    {
+        return $this->_redirect($this->customerUrl->getLoginUrl());
+    }
+
+    /**
+     * @return bool
+     */
+    private function isValidToken()
+    {
+        $isValid = false;
+        try {
+            $isValid = $this->accessTokenRequestValidator->isValid($this->getRequest());
+        } catch (\Zend_Validate_Exception $e) {
+            $this->logger->error($e);
+        }
+
+        return $isValid;
+    }
+
+    /**
+     * @return array
+     */
+    private function getAmazonCustomer()
+    {
         try {
             $userInfo = $this->clientFactory
-                             ->create()
-                             ->getUserInfo($this->getRequest()->getParam('access_token'));
+                ->create()
+                ->getUserInfo($this->getRequest()->getParam('access_token'));
 
             if (is_array($userInfo) && isset($userInfo['user_id'])) {
-                $amazonCustomer = $this->amazonCustomerFactory->create([
-                    'id'    => $userInfo['user_id'],
+                $data = [
+                    'id' => $userInfo['user_id'],
                     'email' => $userInfo['email'],
-                    'name'  => $userInfo['name'],
-                    'country' => $this->amazonCoreHelper->getRegion()
-                ]);
+                    'name' => $userInfo['name'],
+                    'country' => $this->amazonCoreHelper->getRegion(),
+                ];
 
-                $this->storeUserInfoToSession($amazonCustomer);
+                return $data;
             }
         } catch (\Exception $e) {
             $this->logger->error($e);
-            $this->messageManager->addErrorMessage(__('Error processing Amazon Login'));
         }
 
-        return $this->accountRedirect->getRedirect();
-    }
-
-    /**
-     * @param AmazonCustomer $amazonCustomer
-     * @return void
-     */
-    protected function storeUserInfoToSession(AmazonCustomer $amazonCustomer)
-    {
-        $this->customerSession->setAmazonCustomer($amazonCustomer);
+        return [];
     }
 }

--- a/src/Login/Controller/Login/ProcessAuthHash.php
+++ b/src/Login/Controller/Login/ProcessAuthHash.php
@@ -23,7 +23,7 @@ class ProcessAuthHash extends \Magento\Framework\App\Action\Action
     /**
      * @var PageFactory
      */
-    protected $pageFactory;
+    private $pageFactory;
 
     /**
      * @param Context     $context

--- a/src/Login/Controller/Login/Validate.php
+++ b/src/Login/Controller/Login/Validate.php
@@ -19,12 +19,16 @@ use Magento\Framework\App\Action\Action;
 use Magento\Framework\App\Action\Context;
 use Magento\Framework\View\Result\PageFactory;
 
+/**
+ * Class Validate
+ * @package Amazon\Login\Controller\Login
+ */
 class Validate extends Action
 {
     /**
      * @var PageFactory
      */
-    protected $pageFactory;
+    private $pageFactory;
 
     /**
      * Validate constructor.
@@ -41,6 +45,9 @@ class Validate extends Action
         $this->pageFactory = $pageFactory;
     }
 
+    /**
+     * @return \Magento\Framework\App\ResponseInterface|\Magento\Framework\Controller\ResultInterface|\Magento\Framework\View\Result\Page
+     */
     public function execute()
     {
         return $this->pageFactory->create();

--- a/src/Login/Controller/Login/ValidatePost.php
+++ b/src/Login/Controller/Login/ValidatePost.php
@@ -29,27 +29,27 @@ class ValidatePost extends Action
     /**
      * @var Session
      */
-    protected $session;
+    private $session;
 
     /**
      * @var AccountRedirect
      */
-    protected $accountRedirect;
+    private $accountRedirect;
 
     /**
      * @var CustomerRegistry
      */
-    protected $customerRegistry;
+    private $customerRegistry;
 
     /**
      * @var Encryptor
      */
-    protected $encryptor;
+    private $encryptor;
 
     /**
      * @var CustomerManagerInterface
      */
-    protected $customerManager;
+    private $customerLinkManagement;
 
     /**
      * ValidatePost constructor.
@@ -59,7 +59,7 @@ class ValidatePost extends Action
      * @param AccountRedirect          $accountRedirect
      * @param CustomerRegistry         $customerRegistry
      * @param Encryptor                $encryptor
-     * @param CustomerManagerInterface $customerManager
+     * @param customerLinkManagement   $customerLinkManagement
      */
     public function __construct(
         Context $context,
@@ -67,15 +67,15 @@ class ValidatePost extends Action
         AccountRedirect $accountRedirect,
         CustomerRegistry $customerRegistry,
         Encryptor $encryptor,
-        CustomerManagerInterface $customerManager
+        CustomerManagerInterface $customerLinkManagement
     ) {
         parent::__construct($context);
 
-        $this->session          = $session;
-        $this->accountRedirect  = $accountRedirect;
-        $this->customerRegistry = $customerRegistry;
-        $this->encryptor        = $encryptor;
-        $this->customerManager  = $customerManager;
+        $this->session                = $session;
+        $this->accountRedirect        = $accountRedirect;
+        $this->customerRegistry       = $customerRegistry;
+        $this->encryptor              = $encryptor;
+        $this->customerLinkManagement = $customerLinkManagement;
     }
 
     public function execute()
@@ -87,7 +87,7 @@ class ValidatePost extends Action
             $hash     = $this->customerRegistry->retrieveSecureData($credentials->getCustomerId())->getPasswordHash();
 
             if ($this->encryptor->validateHash($password, $hash)) {
-                $this->customerManager->updateLink($credentials->getCustomerId(), $credentials->getAmazonId());
+                $this->customerLinkManagement->updateLink($credentials->getCustomerId(), $credentials->getAmazonId());
                 $this->session->loginById($credentials->getCustomerId());
             } else {
                 $this->messageManager->addErrorMessage('The password supplied was incorrect');

--- a/src/Login/Helper/Session.php
+++ b/src/Login/Helper/Session.php
@@ -19,6 +19,7 @@ use Amazon\Core\Domain\AmazonCustomer;
 use Amazon\Login\Domain\ValidationCredentials;
 use Magento\Customer\Api\Data\CustomerInterface;
 use Magento\Customer\Model\Session as CustomerSession;
+use Magento\Checkout\Model\Session as CheckoutSession;
 use Magento\Framework\Event\ManagerInterface as EventManagerInterface;
 
 class Session
@@ -26,12 +27,17 @@ class Session
     /**
      * @var CustomerSession
      */
-    protected $session;
+    private $session;
+
+    /**
+     * @var CheckoutSession
+     */
+    private $checkoutSession;
 
     /**
      * @var EventManagerInterface
      */
-    protected $eventManager;
+    private $eventManager;
 
     /**
      * @param CustomerSession $session
@@ -39,9 +45,11 @@ class Session
      */
     public function __construct(
         CustomerSession $session,
-        EventManagerInterface $eventManager
+        EventManagerInterface $eventManager,
+        CheckoutSession $checkoutSession
     ) {
         $this->session      = $session;
+        $this->checkoutSession = $checkoutSession;
         $this->eventManager = $eventManager;
     }
 
@@ -56,6 +64,7 @@ class Session
             $this->dispatchAuthenticationEvent();
             $this->session->setCustomerDataAsLoggedIn($customerData);
             $this->session->regenerateId();
+            $this->checkoutSession->loadCustomerQuote();
         }
     }
 

--- a/src/Login/Model/CheckoutConfigProvider.php
+++ b/src/Login/Model/CheckoutConfigProvider.php
@@ -17,20 +17,31 @@ namespace Amazon\Login\Model;
 
 use Magento\Checkout\Model\ConfigProviderInterface;
 use Magento\Customer\Model\Session as CustomerSession;
+use Magento\Checkout\Model\Session as CheckoutSession;
 
 class CheckoutConfigProvider implements ConfigProviderInterface
 {
     /**
      * @var CustomerSession
      */
-    protected $customerSession;
+    private $customerSession;
 
     /**
+     * @var CheckoutSession
+     */
+    private $checkoutSession;
+
+    /**
+     * CheckoutConfigProvider constructor.
      * @param CustomerSession $customerSession
+     * @param CheckoutSession $checkoutSession
      */
-    public function __construct(CustomerSession $customerSession)
-    {
+    public function __construct(
+        CustomerSession $customerSession,
+        CheckoutSession $checkoutSession
+    ) {
         $this->customerSession = $customerSession;
+        $this->checkoutSession = $checkoutSession;
     }
 
     /**
@@ -40,11 +51,16 @@ class CheckoutConfigProvider implements ConfigProviderInterface
     {
         $config = [];
 
-        /** @var \Amazon\Core\Domain\AmazonCustomer $amazonCustomer */
+        /** @var \Amazon\Core\Api\Data\AmazonCustomer $amazonCustomer */
         if ($amazonCustomer = $this->customerSession->getAmazonCustomer()) {
             $config['amazon_customer_email'] = $amazonCustomer->getEmail();
         }
 
+        if (!isset($config['amazon_customer_email'])) {
+            $quote = $this->checkoutSession->getQuote();
+            $config['amazon_customer_email'] = $quote->getCustomerEmail();
+        }
+
         // return a stdClass so that the resulting JSON is an empty object, not an empty array
         return ['amazonLogin' => empty($config) ? new \stdClass : $config];
     }

--- a/src/Login/composer.json
+++ b/src/Login/composer.json
@@ -2,12 +2,12 @@
   "name": "amzn/login-with-amazon-module",
   "description": "Login with Amazon module",
   "type": "magento2-module",
-  "version": "1.2.4",
+  "version": "1.2.8",
   "license": [
     "Apache-2.0"
   ],
   "require": {
-    "amzn/amazon-pay-and-login-with-amazon-core-module": "^1.2.3",
+    "amzn/amazon-pay-and-login-with-amazon-core-module": "^1.2.8",
     "magento/module-customer": "^100.1.0|^101.0.0",
 	"magento/module-checkout": "^100.1.0|^100.2.0"
     

--- a/src/Login/etc/module.xml
+++ b/src/Login/etc/module.xml
@@ -3,8 +3,6 @@
     <module name="Amazon_Login" setup_version="1.2.0">
         <sequence>
             <module name="Amazon_Core"/>
-            <module name="Magento_Customer"/>
-            <module name="Magento_Checkout"/>
         </sequence>
     </module>
 </config>

--- a/src/Login/i18n/en_US.csv
+++ b/src/Login/i18n/en_US.csv
@@ -1,15 +1,117 @@
+"--","--"
+"A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station.","A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station."
+"A shop account for this email address already exists. Please enter your shop accounts password to log in without leaving the shop.","A store account for this email address already exists. Please enter your store account password to log in without leaving the store."
+"Access Key Id","Access Key Id"
 "Action is not available","Action is not available"
+"Advanced","Advanced"
+"Allowed IPs","Allowed IPs"
+"Allowed Javascript Origins","Allowed Javascript Origins"
+"Allowed Return URLs","Allowed Return URLs"
+"Amazon authorize invalid state : %1 with reason %2","Unexpected state for the Amazon Pay authoriziation. State: %1, Reason code: %2"
+"Amazon capture declined : %1","Amazon Pay declined the capture. Reason code: %1"
+"Amazon capture invalid state : %1 with reason %2","Unexpected state for the Amazon Pay capture. State: %1, Reason code: %2"
+"Amazon could not process your request.","Amazon Pay could not process your request. Please try again."
+"Amazon refund invalid state : %1 with reason %2","Unexpected state for the Amazon Pay refund. State: %1, Reason code: %2"
+"Amazon Pay","Amazon Pay"
+"Amazon Pay button in minicart","Amazon Pay button in minicart"
+"Amazon Pay button is visible on Product Page","Amazon Pay button is visible on Product Page"
+"Amazon Pay Logo","Amazon Pay Logo"
+"An unsupported currency is currently selected. Please review our configuration guide.","An unsupported currency is currently selected. Please review our configuration guide."
+"Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.","Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account."
+"Asynchronous","Asynchronous"
+"Authorization Mode","Authorization Mode"
+"Authorization soft decline","Authorization soft decline"
+"Authorization hard decline","Authorization hard decline"
+"Authorization timed out","Authorization timed out"
+"Back","Back"
+"Button Color","Button Color"
+"Button Display Language","Button Display Language"
+"Button Size","Button Size"
+"Capture declined","Capture declined"
+"Capture pending","Capture pending"
+"Captured amount of %1 online","Captured amount of %1 online."
+"Capture declined for Order <a href=""%2"">#%1</a>","Capture declined for Order <a href=""%2"">#%1</a>"
+"Capture pending approval from the payment gateway","Capture pending approval from the payment gateway. Please check back later."
+"Charge on Order","Charge on Order"
+"Charge on Shipment","Charge on Shipment"
+"click here to display the categories","click here to display the categories"
+"Client Id","Client Id"
+"Client Secret","Client Secret"
+"Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
+                            If the field is empty, the buttons will be visible to all clients.","Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
+                            If the field is empty, the buttons will be visible to all clients."
+"Continue as Guest","Continue as Guest"
+"Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>.","Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>."
+"Could not find the ""multiline_count"" config of the ""street"" Customer address attribute.","Could not find the ""multiline_count"" config of the ""street"" Customer address attribute."
+"Credentials,Credentials"
+"Credentials JSON","Credentials JSON"
+"Dark Gray","Dark Gray"
+"Data Polling via Cron Job","Data Polling via Cron Job"
+"Declined amount of %1 online","Online Capture of amount %1 was declined."
+"Developer Options","Developer Options"
+"Enable Amazon Pay","Enable Amazon Pay"
+"Enable Login with Amazon","Enable Login with Amazon"
+"Euro Region","Euro Region"
 "Error processing Amazon Login","Error processing Amazon Login"
-"A shop account for this email address already exists. Please enter your shop accounts password to log in without leaving the shop.","A store account for this email address already exists. Please enter your store account password to log in without leaving the store."
+"Excluded Categories","Excluded Categories"
+"Extra Large","Extra Large"
+"Forgot Your Password?","Forgot Your Password?"
+"Frontend","Frontend"
+"General","General"
+"Get started with account registration","Get started with account registration"
+"Gold","Gold"
+"In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin.","In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin."
+"Instant Payment Notifications","Instant Payment Notifications"
+"Is Packing Stations Terms Validation Enabled","Is Packing Stations Terms Validation Enabled"
+"I've already setup Pay with Amazon, I want to edit my settings","I've already setup Amazon Pay, I want to edit my settings"
+"Japan","Japan"
+"Large","Large"
+"Light Gray","Light Gray"
+"Logging","Logging"
+"Login / Pay","Login / Pay"
 "Login with Amazon","Login with Amazon"
-"With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop.","With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop."
+"Login with Amazon / Amazon Pay","Login with Amazon / Amazon Pay"
+"Login with Amazon available in authentication popup","Login with Amazon available in authentication popup"
+"Medium","Medium"
+"Merchant Id","Merchant Id"
+"Module version","Module version"
+"My account is ready, I need to connect it to Magento","My account is ready, I need to connect it to Magento"
+"New Order Status","New Order Status"
+"No Simulation","No Simulation"
+"Ok","Ok"
+"Options","Options"
+"or","or"
+"Packing Stations Terms","Packing Stations Terms"
+"Password","Password"
+"Paste JSON credentials here","Paste JSON credentials here"
+"Payment Action","Payment Action"
+"Payment Region","Payment Region"
+"Please select a payment method.","Please select a payment method."
+"Refund declined","Refund declined"
+"* Required Fields","* Required Fields"
+"Return to standard checkout","Return to standard checkout"
+"Sales Exclusions","Sales Exclusions"
+"Sales Options","Sales Options"
+"Sandbox","Sandbox"
+"Save Credentials","Save Credentials"
+"Secret Access Key","Secret Access Key"
 "Securely login into our website using your existing Amazon details.","Securely login to our website using your existing Amazon details."
-"Welcome back!","Welcome back!"
-"Continue as Guest","Continue as Guest"
+"Simulate Payment Scenarios","Simulate Payment Scenarios"
+"Small","Small"
+"Synchronous","Synchronous"
+"Synchronous if Possible","Synchronous if Possible"
+"The ""Amazon Pay"" button will not be available for products of the selected categories.","The ""Amazon Pay"" button will not be available for products of the selected categories."
+"the country for your address is not allowed for this store","The country associated with your address is not allowed for this store."
+"The currency selected is not supported by Amazon Pay","The currency selected is not supported by Amazon Pay on this store."
 "the email address for your Amazon account is invalid","The email address for your Amazon account is invalid."
-"* Required Fields","* Required Fields"
-"Password","Password"
-"Ok","Ok"
-"Forgot Your Password?","Forgot Your Password?"
-"Login with Amazon available in authentication popup","Login with Amazon available in authentication popup"
-
+"There has been a problem with the selected payment method on your Amazon account. Please choose another one.","There has been a problem with the selected payment method on your Amazon account. Please choose another one."
+"Unfortunately it is not possible to pay with Amazon Pay for this order. Please choose another payment method.","Unfortunately it is not possible to Pay with Amazon Pay for this order. Please choose another payment method."
+"United Kingdom","United Kingdom"
+"United States","United States"
+"Update Mechanism","Update Mechanism"
+"Updating your config with new keys, please wait...","Updating your config with new keys, please wait..."
+"Valid JSON credentials are required.","Valid JSON credentials are required."
+"Welcome back!","Welcome back!"
+"With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop.","With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop."
+"You will be registering for a %1 account based on the base currency of your shop (%2).","You will be registering for a %1 account based on the base currency of your shop (%2)."
+"Your session has expired, please reload the page and try again.","Your session has expired, please reload the page and try again."
\ No newline at end of file

--- a/src/Login/view/frontend/templates/form/validate.phtml
+++ b/src/Login/view/frontend/templates/form/validate.phtml
@@ -17,31 +17,31 @@
 <div class="amazon-validate-container">
     <div class="block block-amazon-validate">
         <div class="block-title">
-            <strong id="block-amazon-login-heading" role="heading" aria-level="2"><?php /* @escapeNotVerified */ echo __('Welcome back!') ?></strong>
+            <strong id="block-amazon-login-heading" role="heading" aria-level="2"><?php /* @noEscape */ echo __('Welcome back!') ?></strong>
         </div>
         <div class="block-content" aria-labelledby="block-amazon-login-heading">
-            <p><?php /* @escapeNotVerified */ echo __('A shop account for this email address already exists. Please enter your shop accounts password to log in without leaving the shop.') ?></p>
+            <p><?php /* @noEscape */ echo __('A shop account for this email address already exists. Please enter your shop accounts password to log in without leaving the shop.') ?></p>
             <form class="form password validate"
-                  action="<?php /* @escapeNotVerified */ echo $block->getUrl('*/*/validatepost') ?>"
+                  action="<?php echo $block->escapeUrl($block->getUrl('*/*/validatepost')) ?>"
                   method="post"
                   id="form-validate"
                   data-mage-init='{"validation":{}}'>
-                <fieldset class="fieldset" data-hasrequired="<?php /* @escapeNotVerified */ echo __('* Required Fields') ?>">
+                <fieldset class="fieldset" data-hasrequired="<?php /* @noEscape */ echo __('* Required Fields') ?>">
                     <div class="field email required">
-                        <label for="password" class="label"><span><?php /* @escapeNotVerified */ echo __('Password') ?></span></label>
+                        <label for="password" class="label"><span><?php /* @noEscape */ echo __('Password') ?></span></label>
                         <div class="control">
                             <input type="password" name="password" alt="password" id="password" class="input-text" value="" data-validate="{required:true}">
                         </div>
                     </div>
                     <div class="actions-toolbar">
                         <div class="primary">
-                            <button type="submit" class="action submit primary"><span><?php /* @escapeNotVerified */ echo __('Ok') ?></span></button>
+                            <button type="submit" class="action submit primary"><span><?php /* @noEscape */ echo __('Ok') ?></span></button>
                         </div>
                         <div class="secondary continue-as-guest">
-                            <a class="action secondary" href="<?php /* @escapeNotVerified */ echo $block->getContinueAsGuestUrl() ?>"><span><?php /* @escapeNotVerified */ echo __('Continue as Guest') ?></span></a>
+                            <a class="action secondary" href="<?php echo $block->escapeUrl($block->getContinueAsGuestUrl()) ?>"><span><?php /* @noEscape */ echo __('Continue as Guest') ?></span></a>
                         </div>
                         <div class="secondary forgot-password">
-                            <a class="action secondary" href="<?php /* @escapeNotVerified */ echo $block->getForgotPasswordUrl() ?>"><span><?php /* @escapeNotVerified */ echo __('Forgot Your Password?') ?></span></a>
+                            <a class="action secondary" href="<?php echo $block->escapeUrl($block->getForgotPasswordUrl()) ?>"><span><?php /* @noEscape */ echo __('Forgot Your Password?') ?></span></a>
                         </div>
                     </div>
                 </fieldset>

--- a/src/Login/view/frontend/templates/login.phtml
+++ b/src/Login/view/frontend/templates/login.phtml
@@ -17,10 +17,10 @@
 <?php /** @var \Amazon\Login\Block\Login $block */?>
 <div class="block block-amazon-login">
     <div class="block-title">
-        <strong id="block-amazon-login-heading" role="heading" aria-level="2"><?php /* @escapeNotVerified */ echo __('Login with Amazon') ?></strong>
+        <strong id="block-amazon-login-heading" role="heading" aria-level="2"><?php /* @noEscape */ echo __('Login with Amazon') ?></strong>
     </div>
     <div class="block-content" aria-labelledby="block-amazon-login-heading">
-        <p><?php /* @escapeNotVerified */ echo __('With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop. ') ?></p>
+        <p><?php /* @noEscape */ echo __('With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop. ') ?></p>
         <div class="actions-toolbar">
             <div class="primary">
                 <div class="amazon-button-container">
@@ -30,7 +30,7 @@
                     <div class="amazon-button-container__cell">
                         <div class="field-tooltip toggle">
                             <span class="field-tooltip-action action-help" data-mage-init='{"dropdown": {"activeClass": "_active"}}' data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></span>
-                            <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @escapeNotVerified */  echo __('Securely login into our website using your existing Amazon details.'); ?></div>
+                            <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @noEscape */  echo __('Securely login into our website using your existing Amazon details.'); ?></div>
                         </div>
                     </div>
                 </div>

--- a/src/Login/view/frontend/web/js/amazon-csrf.js
+++ b/src/Login/view/frontend/web/js/amazon-csrf.js
@@ -18,25 +18,43 @@ define([
     'jquery',
     'mage/cookies'
 ], function (sjcl, $) {
-    "use strict";
+    'use strict';
 
     return {
         options: {
             wordsLength: 8,
             cookieName: 'amazon-csrf-state'
         },
+
+        /**
+         * Create random string for Amazon CSRF cookie
+         */
         generateNewValue: function () {
             var randomString = sjcl.codec.base64.fromBits(sjcl.random.randomWords(this.options.wordsLength));
+
             $.mage.cookies.set(this.options.cookieName, randomString);
+
             return randomString;
         },
+
+        /**
+         * Check if Amazon CSRF cookie is valid and clear cookie
+         * @param {String} stateString
+         * @returns {Boolean}
+         */
         isValid: function (stateString) {
             var isValid = $.mage.cookies.get(this.options.cookieName) === stateString;
+
             this.clear(); // always clear nonce when validating
+
             return isValid;
         },
+
+        /**
+         * Clear Amazon CSRF cookie
+         */
         clear: function () {
             $.mage.cookies.clear(this.options.cookieName);
         }
-    }
+    };
 });

--- a/src/Login/view/frontend/web/js/amazon-logout.js
+++ b/src/Login/view/frontend/web/js/amazon-logout.js
@@ -16,32 +16,34 @@
 define([
     'jquery',
     'amazonCore',
-    'jquery/ui'
+    'jquery/ui',
+    'mage/cookies'
 ], function ($, core) {
-    "use strict";
-
-    var _this;
+    'use strict';
 
     $.widget('amazon.AmazonLogout', {
         options: {
             onInit: false
         },
+
         /**
          * Create Amazon Logout Widget
          * @private
          */
         _create: function () {
-            _this = this;
             if (this.options.onInit) {
                 core.AmazonLogout(); //logout amazon user on init
+                $.mage.cookies.clear('amazon_Login_accessToken');
             }
         },
+
         /**
          * Logs out a user if called directly
          * @private
          */
         _logoutAmazonUser: function () {
             core.AmazonLogout();
+            $.mage.cookies.clear('amazon_Login_accessToken');
         }
     });
 

--- a/src/Login/view/frontend/web/js/amazon-redirect.js
+++ b/src/Login/view/frontend/web/js/amazon-redirect.js
@@ -21,8 +21,8 @@ define([
     'mage/loader',
     'jquery/ui',
     'mage/cookies'
-], function ($, amazonCore, amazonPaymentConfig, amazonCsrf, loader) {
-    "use strict";
+], function ($, amazonCore, amazonPaymentConfig, amazonCsrf) {
+    'use strict';
 
     var self;
 
@@ -45,7 +45,7 @@ define([
             this.setAuthStateCookies();
             amazonCore.amazonDefined.subscribe(function () {
                 //only set this on the redirect page
-                amazon.Login.setUseCookie(true);
+                amazon.Login.setUseCookie(true); //eslint-disable-line no-undef
                 amazonCore.verifyAmazonLoggedIn().then(function (loggedIn) {
                     if (loggedIn) {
                         self.redirect();
@@ -56,13 +56,13 @@ define([
 
         /**
          * getURLParamater from URL for access OAuth Token
-         * @param name
-         * @param source
-         * @returns {string|null}
+         * @param {String} name
+         * @param {String} source
+         * @returns {String|Null}
          */
         getURLParameter: function (name, source) {
             return decodeURIComponent((new RegExp('[?|&|#]' + name + '=' +
-                    '([^&]+?)(&|#|;|$)').exec(source) || [,""])[1].replace(
+                    '([^&]+?)(&|#|;|$)').exec(source) || [,''])[1].replace(
                         /\+/g,
                         '%20'
                     )) || null;
@@ -70,27 +70,40 @@ define([
 
         /**
          * Set State Cache Auth Cookies if they aren't already set
-         * @returns {boolean}
+         * @returns {Boolean}
          */
         setAuthStateCookies: function () {
-            var token = this.getURLParameter("access_token", location.hash);
+            var token = this.getURLParameter('access_token', location.hash);
+
             if (typeof token === 'string' && token.match(/^Atza/)) {
                 $.mage.cookies.set('amazon_Login_accessToken', token);
             }
+
             return true;
         },
+
         /**
          * Redirect user to correct controller which logs them into M2 via Amazon hash
          */
         redirect: function () {
-            window.location = amazonPaymentConfig.getValue('redirectUrl') + '?access_token=' + this.getURLParameter('access_token', location.hash);
+            window.location = amazonPaymentConfig.getValue('redirectUrl') + '?access_token=' +
+                this.getURLParameter('access_token', location.hash);
         },
+
+        /**
+         * Redirect user on invalid state
+         */
         redirectOnInvalidState: function () {
             var state = this.getURLParameter('state', location.hash);
+
             if (!state || !amazonCsrf.isValid(state)) {
                 window.location = amazonPaymentConfig.getValue('customerLoginPageUrl');
             }
         },
+
+        /**
+         * Redirect user on request error
+         */
         redirectOnRequestWithError: function () {
             if (this.getURLParameter('error', window.location)) {
                 window.location = amazonPaymentConfig.getValue('customerLoginPageUrl');

--- a/src/Login/view/frontend/web/js/view/login-button-wrapper.js
+++ b/src/Login/view/frontend/web/js/view/login-button-wrapper.js
@@ -13,7 +13,10 @@
  * permissions and limitations under the License.
  */
 
-if (window.amazonPayment.allowAmLoginLoading == true) {
+var registry = require('uiRegistry');
+var amazonPayment = registry.get('amazonPayment');
+
+if (amazonPayment != undefined && amazonPayment.allowAmLoginLoading == true) {
     define(['require', 'Amazon_Login/js/view/login-button'], function (require) {
         return require("Amazon_Login/js/view/login-button");
     });
@@ -22,3 +25,4 @@ if (window.amazonPayment.allowAmLoginLoading == true) {
         return require("uiComponent");
     });
 }
+

--- a/src/Payment/Observer/AddAmazonButton.php
+++ b/src/Payment/Observer/AddAmazonButton.php
@@ -25,12 +25,12 @@ class AddAmazonButton implements ObserverInterface
     /**
      * @var Data
      */
-    protected $coreHelper;
+    private $coreHelper;
 
     /**
      * @var ShortcutFactory
      */
-    protected $shortcutFactory;
+    private $shortcutFactory;
 
     /**
      * @param Data $coreHelper
@@ -50,7 +50,6 @@ class AddAmazonButton implements ObserverInterface
         $shortcutButtons = $observer->getEvent()->getContainer();
 
         if ($this->coreHelper->isPwaEnabled() && $this->coreHelper->isCurrentCurrencySupportedByAmazon()) {
-
             $params = [
                 'shortcutValidator' => $this->shortcutFactory->create($observer->getEvent()->getCheckoutSession()),
             ];
@@ -58,7 +57,7 @@ class AddAmazonButton implements ObserverInterface
 
             /** @var \Magento\Framework\View\Element\Template $shortcut */
             $shortcut = $shortcutButtons->getLayout()->createBlock(
-                'Amazon\Payment\Block\Minicart\Button',
+                \Amazon\Payment\Block\Minicart\Button::class,
                 '',
                 $params
             );
@@ -69,7 +68,7 @@ class AddAmazonButton implements ObserverInterface
                 $observer->getEvent()->getOrPosition()
             );
 
-            $shortcut->setIsCart(get_class($shortcutButtons) == 'Magento\Checkout\Block\QuoteShortcutButtons');
+            $shortcut->setIsCart(get_class($shortcutButtons) == \Magento\Checkout\Block\QuoteShortcutButtons::class);
 
             $shortcutButtons->addShortcut($shortcut);
         }

--- a/src/Payment/composer.json
+++ b/src/Payment/composer.json
@@ -2,13 +2,13 @@
   "name": "amzn/amazon-pay-module",
   "description": "Amazon Pay module",
   "type": "magento2-module",
-  "version": "1.2.4",
+  "version": "1.2.8",
   "license": [
     "Apache-2.0"
   ],
   "require": {
-    "amzn/amazon-pay-and-login-with-amazon-core-module": "^1.2.3",
-    "amzn/login-with-amazon-module": "^1.2.3",
+    "amzn/amazon-pay-and-login-with-amazon-core-module": "^1.2.8",
+    "amzn/login-with-amazon-module": "^1.2.8",
     "magento/module-eav": "^100.1.0|^101.0.0",
     "magento/module-sales": "^100.1.0|^101.0.0",
     "magento/module-quote": "^100.1.0|^101.0.0",

--- a/src/Payment/etc/di.xml
+++ b/src/Payment/etc/di.xml
@@ -68,7 +68,6 @@
     <type name="Magento\Framework\Webapi\ErrorProcessor">
         <plugin name="amazon_payment_webapi_error_processor" type="Amazon\Payment\Plugin\WebapiErrorProcessor" sortOrder="1" />
     </type>
-    <type name="Magento\Framework\Mail\MessageInterface" shared="false" />
     <type name="Amazon\Payment\Model\Config">
         <arguments>
             <argument name="methodCode" xsi:type="const">Amazon\Payment\Model\Method\Amazon::PAYMENT_METHOD_CODE</argument>
@@ -79,4 +78,28 @@
             <argument name="amazonConfig" xsi:type="object">Amazon\Payment\Model\Config</argument>
         </arguments>
     </type>
+    <type name="Magento\ScalableCheckout\Console\Command\SplitQuote">
+        <arguments>
+            <argument name="tables" xsi:type="array">
+                <item name="amazon_quote" xsi:type="string">amazon_quote</item>
+            </argument>
+        </arguments>
+    </type>
+    <type name="Amazon\Payment\Model\ResourceModel\QuoteLink">
+        <arguments>
+            <argument name="connectionName" xsi:type="string">checkout</argument>
+        </arguments>
+    </type>
+    <type name="Magento\ScalableOms\Console\Command\SplitSales">
+        <arguments>
+            <argument name="tables" xsi:type="array">
+                <item name="amazon_sales_order" xsi:type="string">amazon_sales_order</item>
+            </argument>
+        </arguments>
+    </type>
+    <type name="Amazon\Payment\Model\ResourceModel\OrderLink">
+        <arguments>
+            <argument name="connectionName" xsi:type="string">sales</argument>
+        </arguments>
+    </type>
 </config>

--- a/src/Payment/etc/module.xml
+++ b/src/Payment/etc/module.xml
@@ -4,11 +4,6 @@
         <sequence>
             <module name="Amazon_Core"/>
             <module name="Amazon_Login"/>
-            <module name="Magento_Eav"/>
-            <module name="Magento_Sales"/>
-            <module name="Magento_Quote"/>
-            <module name="Magento_Payment"/>
-            <module name="Magento_Backend"/>
         </sequence>
     </module>
 </config>

--- a/src/Payment/i18n/en_GB.csv
+++ b/src/Payment/i18n/en_GB.csv
@@ -1,9 +1,9 @@
-"Amazon authorize invalid state : %1 with reason %2","Unexpected state for the Amazon Pay authoriziation. State: %1, Reason code: %2"
+"Amazon authorize invalid state : %1 with reason %2","Unexpected state for the Amazon Pay authorization. State: %1, Reason code: %2"
 "Amazon capture declined : %1","Amazon Pay declined the capture. Reason code: %1"
 "Amazon capture invalid state : %1 with reason %2","Unexpected state for the Amazon Pay capture. State: %1, Reason code: %2"
 "Amazon refund invalid state : %1 with reason %2","Unexpected state for the Amazon Pay refund. State: %1, Reason code: %2"
 "the country for your address is not allowed for this store","The country associated with your address is not allowed for this store."
-"Unfortunately it is not possible to pay with Amazon Pay for this order. Please choose another payment method.","Unfortunately it is not possible to Pay with Amazon Pay for this order. Please choose another payment method."
+"Unfortunately it is not possible to pay with Amazon Pay for this order. Please choose another payment method.","Unfortunately it is not possible to pay with Amazon Pay for this order. Please choose another payment method."
 "There has been a problem with the selected payment method on your Amazon account. Please choose another one.","There has been a problem with the selected payment method on your Amazon account. Please choose another one."
 "The currency selected is not supported by Amazon Pay","The currency selected is not supported by Amazon Pay on this store."
 "Captured amount of %1 online","Captured amount of %1 online."
@@ -17,4 +17,4 @@
 "Amazon could not process your request.","Amazon Pay could not process your request. Please try again."
 "Please select a payment method.","Please select a payment method."
 "Your session has expired, please reload the page and try again.","Your session has expired, please reload the page and try again."
-"Return to standard checkout","Return to standard checkout"
\ No newline at end of file
+"Return to standard checkout","Return to standard checkout"

--- a/src/Payment/i18n/en_US.csv
+++ b/src/Payment/i18n/en_US.csv
@@ -1,20 +1,117 @@
+"--","--"
+"A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station.","A comma-separated list of case-insensitive terms which will be used to check whether a Customer Address is a locker or packing station."
+"A shop account for this email address already exists. Please enter your shop accounts password to log in without leaving the shop.","A store account for this email address already exists. Please enter your store account password to log in without leaving the store."
+"Access Key Id","Access Key Id"
+"Action is not available","Action is not available"
+"Advanced","Advanced"
+"Allowed IPs","Allowed IPs"
+"Allowed Javascript Origins","Allowed Javascript Origins"
+"Allowed Return URLs","Allowed Return URLs"
 "Amazon authorize invalid state : %1 with reason %2","Unexpected state for the Amazon Pay authoriziation. State: %1, Reason code: %2"
 "Amazon capture declined : %1","Amazon Pay declined the capture. Reason code: %1"
 "Amazon capture invalid state : %1 with reason %2","Unexpected state for the Amazon Pay capture. State: %1, Reason code: %2"
+"Amazon could not process your request.","Amazon Pay could not process your request. Please try again."
 "Amazon refund invalid state : %1 with reason %2","Unexpected state for the Amazon Pay refund. State: %1, Reason code: %2"
-"the country for your address is not allowed for this store","The country associated with your address is not allowed for this store."
-"Unfortunately it is not possible to pay with Amazon Pay for this order. Please choose another payment method.","Unfortunately it is not possible to Pay with Amazon Pay for this order. Please choose another payment method."
-"There has been a problem with the selected payment method on your Amazon account. Please choose another one.","There has been a problem with the selected payment method on your Amazon account. Please choose another one."
-"The currency selected is not supported by Amazon Pay","The currency selected is not supported by Amazon Pay on this store."
-"Captured amount of %1 online","Captured amount of %1 online."
-"Declined amount of %1 online","Online Capture of amount %1 was declined."
+"Amazon Pay","Amazon Pay"
+"Amazon Pay button in minicart","Amazon Pay button in minicart"
+"Amazon Pay button is visible on Product Page","Amazon Pay button is visible on Product Page"
+"Amazon Pay Logo","Amazon Pay Logo"
+"An unsupported currency is currently selected. Please review our configuration guide.","An unsupported currency is currently selected. Please review our configuration guide."
+"Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.","Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account."
+"Asynchronous","Asynchronous"
+"Authorization Mode","Authorization Mode"
+"Authorization soft decline","Authorization soft decline"
+"Authorization hard decline","Authorization hard decline"
+"Authorization timed out","Authorization timed out"
+"Back","Back"
+"Button Color","Button Color"
+"Button Display Language","Button Display Language"
+"Button Size","Button Size"
 "Capture declined","Capture declined"
+"Capture pending","Capture pending"
+"Captured amount of %1 online","Captured amount of %1 online."
 "Capture declined for Order <a href=""%2"">#%1</a>","Capture declined for Order <a href=""%2"">#%1</a>"
 "Capture pending approval from the payment gateway","Capture pending approval from the payment gateway. Please check back later."
+"Charge on Order","Charge on Order"
+"Charge on Shipment","Charge on Shipment"
+"click here to display the categories","click here to display the categories"
+"Client Id","Client Id"
+"Client Secret","Client Secret"
+"Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
+                            If the field is empty, the buttons will be visible to all clients.","Comma separated. The ""Login with Amazon"" and ""Amazon Pay"" buttons will <em>only</em> be rendered for clients having the above IPs.
+                            If the field is empty, the buttons will be visible to all clients."
+"Continue as Guest","Continue as Guest"
+"Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>.","Controls button and widget language. The default is your shop's locale. Available options can be found <a href=""https://payments.amazon.co.uk/developer/documentation/lpwa/201953980#ENTER_LANGUAGE_PARAMETER"">here</a>."
 "Could not find the ""multiline_count"" config of the ""street"" Customer address attribute.","Could not find the ""multiline_count"" config of the ""street"" Customer address attribute."
-"Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.","Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account."
-"Simulate Payment Scenarios","Simulate Payment Scenarios"
-"Amazon could not process your request.","Amazon Pay could not process your request. Please try again."
+"Credentials,Credentials"
+"Credentials JSON","Credentials JSON"
+"Dark Gray","Dark Gray"
+"Data Polling via Cron Job","Data Polling via Cron Job"
+"Declined amount of %1 online","Online Capture of amount %1 was declined."
+"Developer Options","Developer Options"
+"Enable Amazon Pay","Enable Amazon Pay"
+"Enable Login with Amazon","Enable Login with Amazon"
+"Euro Region","Euro Region"
+"Error processing Amazon Login","Error processing Amazon Login"
+"Excluded Categories","Excluded Categories"
+"Extra Large","Extra Large"
+"Forgot Your Password?","Forgot Your Password?"
+"Frontend","Frontend"
+"General","General"
+"Get started with account registration","Get started with account registration"
+"Gold","Gold"
+"In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin.","In order to enable automatic account configuration using Amazon's secure key exchange, please turn on secure admin pages in General > Web > Use secure URLs in Admin."
+"Instant Payment Notifications","Instant Payment Notifications"
+"Is Packing Stations Terms Validation Enabled","Is Packing Stations Terms Validation Enabled"
+"I've already setup Pay with Amazon, I want to edit my settings","I've already setup Amazon Pay, I want to edit my settings"
+"Japan","Japan"
+"Large","Large"
+"Light Gray","Light Gray"
+"Logging","Logging"
+"Login / Pay","Login / Pay"
+"Login with Amazon","Login with Amazon"
+"Login with Amazon / Amazon Pay","Login with Amazon / Amazon Pay"
+"Login with Amazon available in authentication popup","Login with Amazon available in authentication popup"
+"Medium","Medium"
+"Merchant Id","Merchant Id"
+"Module version","Module version"
+"My account is ready, I need to connect it to Magento","My account is ready, I need to connect it to Magento"
+"New Order Status","New Order Status"
+"No Simulation","No Simulation"
+"Ok","Ok"
+"Options","Options"
+"or","or"
+"Packing Stations Terms","Packing Stations Terms"
+"Password","Password"
+"Paste JSON credentials here","Paste JSON credentials here"
+"Payment Action","Payment Action"
+"Payment Region","Payment Region"
 "Please select a payment method.","Please select a payment method."
-"Your session has expired, please reload the page and try again.","Your session has expired, please reload the page and try again."
-"Return to standard checkout","Return to standard checkout"
\ No newline at end of file
+"Refund declined","Refund declined"
+"* Required Fields","* Required Fields"
+"Return to standard checkout","Return to standard checkout"
+"Sales Exclusions","Sales Exclusions"
+"Sales Options","Sales Options"
+"Sandbox","Sandbox"
+"Save Credentials","Save Credentials"
+"Secret Access Key","Secret Access Key"
+"Securely login into our website using your existing Amazon details.","Securely login to our website using your existing Amazon details."
+"Simulate Payment Scenarios","Simulate Payment Scenarios"
+"Small","Small"
+"Synchronous","Synchronous"
+"Synchronous if Possible","Synchronous if Possible"
+"The ""Amazon Pay"" button will not be available for products of the selected categories.","The ""Amazon Pay"" button will not be available for products of the selected categories."
+"the country for your address is not allowed for this store","The country associated with your address is not allowed for this store."
+"The currency selected is not supported by Amazon Pay","The currency selected is not supported by Amazon Pay on this store."
+"the email address for your Amazon account is invalid","The email address for your Amazon account is invalid."
+"There has been a problem with the selected payment method on your Amazon account. Please choose another one.","There has been a problem with the selected payment method on your Amazon account. Please choose another one."
+"Unfortunately it is not possible to pay with Amazon Pay for this order. Please choose another payment method.","Unfortunately it is not possible to Pay with Amazon Pay for this order. Please choose another payment method."
+"United Kingdom","United Kingdom"
+"United States","United States"
+"Update Mechanism","Update Mechanism"
+"Updating your config with new keys, please wait...","Updating your config with new keys, please wait..."
+"Valid JSON credentials are required.","Valid JSON credentials are required."
+"Welcome back!","Welcome back!"
+"With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop.","With Amazon Pay and Login with Amazon, you can easily sign-in and use the shipping and payment information stored in your Amazon account to place an order on this shop."
+"You will be registering for a %1 account based on the base currency of your shop (%2).","You will be registering for a %1 account based on the base currency of your shop (%2)."
+"Your session has expired, please reload the page and try again.","Your session has expired, please reload the page and try again."
\ No newline at end of file

--- a/src/Payment/view/frontend/templates/minicart-button.phtml
+++ b/src/Payment/view/frontend/templates/minicart-button.phtml
@@ -33,13 +33,13 @@ $tooltipConfig = [
 <div id="minicart-amazon-pay-button" class="amazon-minicart-container">
     <div class="amazon-button-container">
         <div class="amazon-button-container__cell">
-            <div id="PayWithAmazon-<?php echo $block->getParentBlock()->getJsId() ?>" class="login-with-amazon" data-mage-init='<?php /* @noEscape */ echo json_encode($config); ?>'></div>
+            <div id="PayWithAmazon-<?php echo $block->getParentBlock()->getJsId() ?>" class="login-with-amazon login-with-amazon-mini" data-mage-init='<?php /* @noEscape */ echo json_encode($config); ?>'></div>
         </div>
 
         <div class="amazon-button-container__cell">
             <div class="field-tooltip toggle">
                 <span class="field-tooltip-action action-help" data-mage-init='<?php /* @noEscape */ echo json_encode($tooltipConfig); ?>' data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></span>
-                <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @escapeNotVerified */  echo __('Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.'); ?></div>
+                <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @noEscape */  echo __('Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.'); ?></div>
             </div>
         </div>
     </div>

--- a/src/Payment/view/frontend/templates/payment-link-product-page.phtml
+++ b/src/Payment/view/frontend/templates/payment-link-product-page.phtml
@@ -18,12 +18,12 @@
 <div class="amazon-button-container centered-button">
     <div class="amazon-button-container__cell">
         <a href="javascript:;" class="amazon-addtoCart" id="amazon-addtoCart-<?php echo $block->getJsId() ?>" data-mage-init='{"amazonProductAdd": {}}'></a>
-        <div id="LoginWithAmazon-<?php echo $block->getJsId() ?>" class="login-with-amazon" data-mage-init='{"amazonButton": {"buttonType": "PwA"}}'></div>
+        <div id="LoginWithAmazon-<?php echo $block->getJsId() ?>" class="login-with-amazon login-with-amazon-product" data-mage-init='{"amazonButton": {"buttonType": "PwA"}}'></div>
     </div>
     <div class="amazon-button-container__cell">
         <div class="field-tooltip toggle">
             <span class="field-tooltip-action action-help" data-bind="mageInit: {'dropdown':{'activeClass': '_active'}}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></span>
-            <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @escapeNotVerified */  echo __('Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.'); ?></div>
+            <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @noEscape */  echo __('Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.'); ?></div>
         </div>
     </div>
 </div>

--- a/src/Payment/view/frontend/templates/payment-link.phtml
+++ b/src/Payment/view/frontend/templates/payment-link.phtml
@@ -22,7 +22,7 @@
     <div class="amazon-button-container__cell">
         <div class="field-tooltip toggle">
             <span class="field-tooltip-action action-help" data-bind="mageInit: {'dropdown':{'activeClass': '_active'}}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></span>
-            <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @escapeNotVerified */  echo __('Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.'); ?></div>
+            <div class="field-tooltip-content" data-target="dropdown" aria-hidden="true"><?php /* @noEscape */  echo __('Are you an Amazon customer? Pay now with address and payment details stored in your Amazon account.'); ?></div>
         </div>
     </div>
 </div>

--- a/src/Payment/view/frontend/web/js/amazon-product-add.js
+++ b/src/Payment/view/frontend/web/js/amazon-product-add.js
@@ -43,7 +43,7 @@ define([
                 //only trigger the amazon button click if the user has chosen to add to cart via this method
                 if (addedViaAmazon) {
                     addedViaAmazon = false;
-                    $('.login-with-amazon img').trigger('click');
+                    $('.login-with-amazon-mini img').trigger('click');
                 }
             }, this);
 
@@ -52,6 +52,11 @@ define([
                 if ($(_this.options.addToCartForm).valid()) {
                     addedViaAmazon = true;
                     $(_this.options.addToCartForm).submit();
+                    var intervalId = setInterval(function () {
+                        clearInterval(intervalId);
+                        $('.login-with-amazon-mini img').trigger('click');
+                    }, 1000);
+                    return false;
                 }
             });
         }

--- a/src/Payment/view/frontend/web/js/amazon-widgets-loader.js
+++ b/src/Payment/view/frontend/web/js/amazon-widgets-loader.js
@@ -13,6 +13,14 @@
  * permissions and limitations under the License.
  */
 
-define([window.amazonPayment.widgetUrl], function () {
-    //after amazon widgets file as loaded
-});
+var registry = require('uiRegistry'),
+    amazonPayment = registry.get('amazonPayment');
+
+if (amazonPayment !== undefined) {
+    define([amazonPayment.widgetUrl], function () {
+        'use strict';
+
+        //after amazon widgets file as loaded
+    });
+}
+

--- a/src/Payment/view/frontend/web/js/catalog-add-to-cart.js
+++ b/src/Payment/view/frontend/web/js/catalog-add-to-cart.js
@@ -23,8 +23,9 @@ define([
     $.widget('amazon.catalogAddToCart', $.mage.catalogAddToCart, {
 
         _create: function () {
-            //this is overridden here and ignores the redirect option until fixed by Magento (as of 2.1)
-            this._bindSubmit();
+            if (this.options.bindSubmit) {
+                this._bindSubmit();
+            }
         },
 
         _bindSubmit: function () {

--- a/src/Payment/view/frontend/web/js/model/amazonPaymentConfig.js
+++ b/src/Payment/view/frontend/web/js/model/amazonPaymentConfig.js
@@ -13,11 +13,11 @@
  * permissions and limitations under the License.
  */
 define(
-    [],
-    function () {
+    ['uiRegistry'],
+    function (registry) {
         'use strict';
 
-        var config = window.amazonPayment || {};
+	var config = registry.get('amazonPayment') || {};
 
         return {
             getValue: function (key, defaultValue) {
@@ -28,7 +28,7 @@ define(
                 }
             },
             isDefined: function () {
-                return window.amazonPayment !== undefined
+		return registry.get('amazonPayment') !== undefined;
             }
         };
     }

--- a/src/Payment/view/frontend/web/js/view/checkout-revert.js
+++ b/src/Payment/view/frontend/web/js/view/checkout-revert.js
@@ -9,7 +9,8 @@ define(
         'mage/storage',
         'Magento_Checkout/js/model/error-processor',
         'Magento_Checkout/js/model/url-builder',
-        'Magento_Checkout/js/model/full-screen-loader'
+        'Magento_Checkout/js/model/full-screen-loader',
+	'uiRegistry'
     ],
     function (
         $,
@@ -20,18 +21,19 @@ define(
         storage,
         errorProcessor,
         urlBuilder,
-        fullScreenLoader
+        fullScreenLoader,
+	registry
     ) {
         'use strict';
 
         var self;
-
+        if (registry.get('amazonPayment') !== undefined) {
         return Component.extend({
             defaults: {
                 template: 'Amazon_Payment/checkout-revert'
             },
             isAmazonAccountLoggedIn: amazonStorage.isAmazonAccountLoggedIn,
-            isAmazonEnabled: ko.observable(window.amazonPayment.isPwaEnabled),
+	    isAmazonEnabled: ko.observable(registry.get('amazonPayment').isPwaEnabled),
             initialize: function () {
                 self = this;
                 this._super();
@@ -54,5 +56,8 @@ define(
                 );
             }
         });
+        } else {
+            return Component.extend({});
+        }
     }
 );

--- a/src/Payment/view/frontend/web/js/view/checkout-sandbox-simulator.js
+++ b/src/Payment/view/frontend/web/js/view/checkout-sandbox-simulator.js
@@ -3,32 +3,39 @@
 define(
     [
         'jquery',
-        "uiComponent",
+        'uiComponent',
         'ko',
-        'Amazon_Payment/js/model/storage'
+        'Amazon_Payment/js/model/storage',
+        'uiRegistry'
     ],
     function (
         $,
         Component,
         ko,
-        amazonStorage
+        amazonStorage,
+        registry
     ) {
         'use strict';
+        if (registry.get('amazonPayment') !== undefined) {
+            return Component.extend({
+                defaults: {
+                    template: 'Amazon_Payment/checkout-sandbox-simulator'
+                },
+                isAmazonAccountLoggedIn: amazonStorage.isAmazonAccountLoggedIn,
+                isSandboxEnabled: ko.observable(registry.get('amazonPayment').isSandboxEnabled),
+                sandboxSimulationReference: amazonStorage.sandboxSimulationReference,
+                sandboxSimulationOptions: ko.observableArray(registry.get('amazonPayment').sandboxSimulationOptions),
 
-        var self;
-
-        return Component.extend({
-            defaults: {
-                template: 'Amazon_Payment/checkout-sandbox-simulator'
-            },
-            isAmazonAccountLoggedIn: amazonStorage.isAmazonAccountLoggedIn,
-            isSandboxEnabled: ko.observable(window.amazonPayment.isSandboxEnabled),
-            sandboxSimulationReference: amazonStorage.sandboxSimulationReference,
-            sandboxSimulationOptions: ko.observableArray(window.amazonPayment.sandboxSimulationOptions),
-            initialize: function () {
-                self = this;
-                this._super();
-            }
-        });
+                /**
+                 * Init
+                 */
+                initialize: function () {
+                    this._super();
+                }
+            });
+        }
+        else {
+            return Component.extend({});
+        }
     }
-);
\ No newline at end of file
+);

--- a/src/Payment/view/frontend/web/js/view/checkout-widget-address.js
+++ b/src/Payment/view/frontend/web/js/view/checkout-widget-address.js
@@ -3,7 +3,7 @@
 define(
     [
         'jquery',
-        "uiComponent",
+        'uiComponent',
         'ko',
         'Magento_Customer/js/model/customer',
         'Magento_Checkout/js/model/quote',
@@ -18,7 +18,8 @@ define(
         'Magento_Checkout/js/model/error-processor',
         'Magento_Checkout/js/model/url-builder',
         'Magento_Checkout/js/checkout-data',
-        'Magento_Checkout/js/model/checkout-data-resolver'
+        'Magento_Checkout/js/model/checkout-data-resolver',
+        'uiRegistry'
     ],
     function (
         $,
@@ -37,105 +38,143 @@ define(
         errorProcessor,
         urlBuilder,
         checkoutData,
-        checkoutDataResolver
+        checkoutDataResolver,
+        registry
     ) {
         'use strict';
+
         var self;
+        if (registry.get('amazonPayment') !== undefined) {
+            return Component.extend({
+                defaults: {
+                    template: 'Amazon_Payment/checkout-widget-address'
+                },
+                options: {
+                    sellerId: registry.get('amazonPayment').merchantId,
+                    addressWidgetDOMId: 'addressBookWidgetDiv',
+                    widgetScope: registry.get('amazonPayment').loginScope
+                },
+                isCustomerLoggedIn: customer.isLoggedIn,
+                isAmazonAccountLoggedIn: amazonStorage.isAmazonAccountLoggedIn,
+                isAmazonEnabled: ko.observable(registry.get('amazonPayment').isPwaEnabled),
+                rates: shippingService.getShippingRates(),
+
+                /**
+                 * Init
+                 */
+                initialize: function () {
+                    self = this;
+                    this._super();
+                },
+
+                /**
+                 * Call when component template is rendered
+                 */
+                initAddressWidget: function () {
+                    self.renderAddressWidget();
+                },
+
+                /**
+                 * render Amazon address Widget
+                 */
+                renderAddressWidget: function () {
+                    new OffAmazonPayments.Widgets.AddressBook({ // eslint-disable-line no-undef
+                        sellerId: self.options.sellerId,
+                        scope: self.options.widgetScope,
+
+                        /**
+                         * Order reference creation callback
+                         */
+                        onOrderReferenceCreate: function (orderReference) {
+                            var orderid = orderReference.getAmazonOrderReferenceId();
+
+                            amazonStorage.setOrderReference(orderid);
+                        },
+
+                        /**
+                         * Address select callback
+                         */
+                        onAddressSelect: function () { // orderReference
+                            self.getShippingAddressFromAmazon();
+                        },
+                        design: {
+                            designMode: 'responsive'
+                        },
+
+                        /**
+                         * Error callback
+                         */
+                        onError: function (error) {
+                            console.log(error);
+                        }
+                    }).bind(self.options.addressWidgetDOMId);
+                },
+
+                /**
+                 * Get shipping address from Amazon API
+                 */
+                getShippingAddressFromAmazon: function () {
+                    var serviceUrl, payload;
+
+                    amazonStorage.isShippingMethodsLoading(true);
+                    shippingService.isLoading(true);
+                    serviceUrl = urlBuilder.createUrl('/amazon-shipping-address/:amazonOrderReference', {
+                        amazonOrderReference: amazonStorage.getOrderReference()
+                    }),
+                        payload = {
+                            addressConsentToken: amazonStorage.getAddressConsentToken()
+                        };
+
+                    storage.put(
+                        serviceUrl,
+                        JSON.stringify(payload)
+                    ).done(
+                        function (data) {
+                            var amazonAddress = data.shift(),
+                                addressData = addressConverter.formAddressDataToQuoteAddress(amazonAddress),
+                                i;
 
-        return Component.extend({
-            defaults: {
-                template: 'Amazon_Payment/checkout-widget-address'
-            },
-            options: {
-                sellerId: window.amazonPayment.merchantId,
-                addressWidgetDOMId: 'addressBookWidgetDiv',
-                widgetScope: window.amazonPayment.loginScope
-            },
-            isCustomerLoggedIn: customer.isLoggedIn,
-            isAmazonAccountLoggedIn: amazonStorage.isAmazonAccountLoggedIn,
-            isAmazonEnabled: ko.observable(window.amazonPayment.isPwaEnabled),
-            rates: shippingService.getShippingRates(),
-            initialize: function () {
-                self = this;
-                this._super();
-            },
-            /**
-             * Call when component template is rendered
-             */
-            initAddressWidget: function () {
-                self.renderAddressWidget();
-            },
-            /**
-             * render Amazon address Widget
-             */
-            renderAddressWidget: function () {
-                new OffAmazonPayments.Widgets.AddressBook({
-                    sellerId: self.options.sellerId,
-                    scope: self.options.widgetScope,
-                    onOrderReferenceCreate: function (orderReference) {
-                        var orderid = orderReference.getAmazonOrderReferenceId();
-                        amazonStorage.setOrderReference(orderid);
-                    },
-                    onAddressSelect: function (orderReference) {
-                        self.getShippingAddressFromAmazon();
-                    },
-                    design: {
-                        designMode: 'responsive'
-                    },
-                    onError: function (error) {
-                    }
-                }).bind(self.options.addressWidgetDOMId);
-            },
-
-            /**
-             * Get shipping address from Amazon API
-             */
-            getShippingAddressFromAmazon: function () {
-                amazonStorage.isShippingMethodsLoading(true);
-                shippingService.isLoading(true);
-                var serviceUrl = urlBuilder.createUrl('/amazon-shipping-address/:amazonOrderReference', {amazonOrderReference: amazonStorage.getOrderReference()}),
-                    payload = {
-                        addressConsentToken: amazonStorage.getAddressConsentToken()
-                };
-
-                storage.put(
-                    serviceUrl,
-                    JSON.stringify(payload)
-                ).done(
-                    function (data) {
-                        var amazonAddress = data.shift(),
-                            addressData = addressConverter.formAddressDataToQuoteAddress(amazonAddress);
-
-                        //if telephone is blank set it to 00000000 so it passes the required validation
-                        addressData.telephone = !(addressData.telephone) ? '0000000000' : addressData.telephone;
-
-                        //fill in blank street fields
-                        if ($.isArray(addressData.street)) {
-                            for (var i = addressData.street.length; i <= 2; i++) {
-                                addressData.street[i] = '';
+                            //if telephone is blank set it to 00000000 so it passes the required validation
+                            addressData.telephone = !addressData.telephone ? '0000000000' : addressData.telephone;
+
+                            //fill in blank street fields
+                            if ($.isArray(addressData.street)) {
+                                for (i = addressData.street.length; i <= 2; i++) {
+                                    addressData.street[i] = '';
+                                }
                             }
+                            checkoutData.setShippingAddressFromData(
+                                addressConverter.quoteAddressToFormAddressData(addressData)
+                            );
+                            checkoutDataResolver.resolveEstimationAddress();
+                        }
+                    ).fail(
+                        function (response) {
+                            errorProcessor.process(response);
+                            //remove shipping loader and set shipping rates to 0 on a fail
+                            shippingService.setShippingRates([]);
+                            amazonStorage.isShippingMethodsLoading(false);
                         }
-                        checkoutData.setShippingAddressFromData(addressConverter.quoteAddressToFormAddressData(addressData));
-                        checkoutDataResolver.resolveEstimationAddress();
-                    }
-                ).fail(
-                    function (response) {
-                        errorProcessor.process(response);
-                        //remove shipping loader and set shipping rates to 0 on a fail
-                        shippingService.setShippingRates([]);
-                        amazonStorage.isShippingMethodsLoading(false);
-                    }
-                );
-            },
-
-            getAmazonOrderReference: function () {
-                return amazonStorage.getOrderReference();
-            },
-
-            getAddressConsentToken: function () {
-                return amazonStorage.getAddressConsentToken();
-            }
-        });
+                    );
+                },
+
+                /**
+                 * Get Amazon Order Reference ID
+                 */
+                getAmazonOrderReference: function () {
+                    return amazonStorage.getOrderReference();
+                },
+
+                /**
+                 * Get Amazon Address Consent Token
+                 */
+                getAddressConsentToken: function () {
+                    return amazonStorage.getAddressConsentToken();
+                }
+            });
+        } else {
+            return Component.extend({});
+        }
     }
 );
 

--- a/src/Payment/view/frontend/web/js/view/notification.js
+++ b/src/Payment/view/frontend/web/js/view/notification.js
@@ -5,14 +5,16 @@ define(
         "underscore",
         'ko',
         'uiComponent',
-        'Amazon_Payment/js/model/storage'
+        'Amazon_Payment/js/model/storage',
+	'uiRegistry'
     ],
     function (
         $,
         _,
         ko,
         Component,
-        amazonStorage
+        amazonStorage,
+	registry
     ) {
         'use strict';
 
@@ -23,8 +25,8 @@ define(
                 template: 'Amazon_Payment/notification'
             },
             isAmazonAccountLoggedIn: amazonStorage.isAmazonAccountLoggedIn,
-            chargeOnOrder: ko.observable(window.amazonPayment.chargeOnOrder),
-            isEuPaymentRegion: ko.observable(window.amazonPayment.isEuPaymentRegion),
+            chargeOnOrder: ko.observable(registry.get('amazonPayment').chargeOnOrder),
+	    isEuPaymentRegion: ko.observable(registry.get('amazonPayment').isEuPaymentRegion),
             initialize: function () {
                 self = this;
                 this._super();

--- a/src/Payment/view/frontend/web/js/view/payment/method-renderer/amazon-payment-widget.js
+++ b/src/Payment/view/frontend/web/js/view/payment/method-renderer/amazon-payment-widget.js
@@ -16,7 +16,8 @@ define(
         'Magento_Checkout/js/action/select-billing-address',
         'Magento_Checkout/js/model/payment/additional-validators',
         'Magento_Checkout/js/model/url-builder',
-        'amazonPaymentConfig'
+        'amazonPaymentConfig',
+        'uiRegistry'
     ],
     function (
         $,
@@ -35,7 +36,8 @@ define(
         selectBillingAddress,
         additionalValidators,
         urlBuilder,
-        amazonPaymentConfig
+        amazonPaymentConfig,
+        registry
     ) {
         'use strict';
 
@@ -46,11 +48,10 @@ define(
             defaults: {
                 template: 'Amazon_Payment/payment/amazon-payment-widget'
             },
-
             options: {
-                sellerId: window.amazonPayment.merchantId,
+                sellerId: registry.get('amazonPayment').merchantId,
                 paymentWidgetDOMId: 'walletWidgetDiv',
-                widgetScope: window.amazonPayment.loginScope
+                widgetScope: registry.get('amazonPayment').loginScope
             },
             isCustomerLoggedIn: customer.isLoggedIn,
             isAmazonAccountLoggedIn: amazonStorage.isAmazonAccountLoggedIn,
@@ -58,54 +59,93 @@ define(
             shippingAddress: quote.shippingAddress,
             billingAddress: quote.billingAddress,
             isPlaceOrderDisabled: amazonStorage.isPlaceOrderDisabled,
+
+            /**
+             * Inits
+             */
             initialize: function () {
                 self = this;
                 this._super();
             },
+
+            /**
+             * Init payment widget
+             */
             initPaymentWidget: function () {
                 var $amazonPayment = $('#amazon_payment');
+
                 self.renderPaymentWidget();
                 $amazonPayment.trigger('click'); //activate Amazon Pay method on render
                 $amazonPayment.trigger('rendered');
-
             },
+
             /**
              * render Amazon payment Widget
              */
             renderPaymentWidget: function () {
-                new OffAmazonPayments.Widgets.Wallet({
+                new OffAmazonPayments.Widgets.Wallet({ // eslint-disable-line no-undef
                     sellerId: self.options.sellerId,
                     scope: self.options.widgetScope,
                     amazonOrderReferenceId: amazonStorage.getOrderReference(),
-                    onPaymentSelect: function (orderReference) {
+
+                    /**
+                     * Payment select callback
+                     */
+                    onPaymentSelect: function () { // orderReference
                         amazonStorage.isPlaceOrderDisabled(true);
                         self.setBillingAddressFromAmazon();
                     },
                     design: {
                         designMode: 'responsive'
                     },
+
+                    /**
+                     * Error callback
+                     */
                     onError: function (error) {
                         errorProcessor.process(error);
                     }
                 }).bind(self.options.paymentWidgetDOMId);
             },
+
+            /**
+             * Return payment code
+             */
             getCode: function () {
                 return 'amazon_payment';
             },
+
+            /**
+             * Is widget active?
+             */
             isActive: function () {
                 return true;
             },
+
+            /**
+             * Return country name
+             */
             getCountryName: function (countryId) {
-                return (countryData()[countryId] != undefined) ? countryData()[countryId].name : "";
+                return countryData()[countryId] !== undefined ? countryData()[countryId].name : '';
             },
+
+            /**
+             * Check if country name set
+             */
             checkCountryName: function (countryId) {
-                return (countryData()[countryId] != undefined);
+                return countryData()[countryId] !== undefined;
             },
+
+            /**
+             * Save billing address
+             */
             setBillingAddressFromAmazon: function () {
-                var serviceUrl = urlBuilder.createUrl('/amazon-billing-address/:amazonOrderReference', {amazonOrderReference: amazonStorage.getOrderReference()}),
+                var serviceUrl = urlBuilder.createUrl('/amazon-billing-address/:amazonOrderReference', {
+                        amazonOrderReference: amazonStorage.getOrderReference()
+                    }),
                     payload = {
-                        addressConsentToken : amazonStorage.getAddressConsentToken()
-                };
+                        addressConsentToken: amazonStorage.getAddressConsentToken()
+                    };
 
                 fullScreenLoader.startLoader();
 
@@ -114,13 +154,20 @@ define(
                     JSON.stringify(payload)
                 ).done(
                     function (data) {
-                        var amazonAddress = data.shift();
-                        var addressData = addressConverter.formAddressDataToQuoteAddress(amazonAddress);
+                        var amazonAddress = data.shift(),
+                            addressData;
 
-                        addressData.telephone = !(addressData.telephone) ? '0000000000' : addressData.telephone;
+                        addressData = addressConverter.formAddressDataToQuoteAddress(amazonAddress);
+                        addressData.telephone = !addressData.telephone ? '0000000000' : addressData.telephone;
 
                         selectBillingAddress(addressData);
                         amazonStorage.isPlaceOrderDisabled(false);
+                        if(window.checkoutConfig.amazonLogin.amazon_customer_email) {
+                            var customerField = $('#customer-email').val();
+                            if (!customerField) {
+                                $('#customer-email').val(window.checkoutConfig.amazonLogin.amazon_customer_email);
+                            }
+                        }
                     }
                 ).fail(
                     function (response) {
@@ -132,17 +179,26 @@ define(
                     }
                 );
             },
+
+            /**
+             * Return Magento billing object
+             */
             getData: function () {
                 return {
-                    "method": this.item.method,
-                    "additional_data": {
-                        "sandbox_simulation_reference": amazonStorage.sandboxSimulationReference()
+                    'method': this.item.method,
+                    'additional_data': {
+                        'sandbox_simulation_reference': amazonStorage.sandboxSimulationReference()
                     }
-                }
+                };
             },
+
+            /**
+             * Save order
+             */
             placeOrder: function (data, event) {
-                var self = this,
-                    placeOrder;
+                var placeOrder;
+
+                self = this;
 
                 if (event) {
                     event.preventDefault();
@@ -155,8 +211,10 @@ define(
                     $.when(placeOrder).fail(function () {
                         self.isPlaceOrderActionAllowed(true);
                     }).done(this.afterPlaceOrder.bind(this));
+
                     return true;
                 }
+
                 return false;
             }
         });

